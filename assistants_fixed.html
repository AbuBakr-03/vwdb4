<!-- Your existing assistants template content remains the same, but with this updated JavaScript section -->

<script>
// Get CSRF token
function getCSRFToken() {
    const csrfInput = document.querySelector('[name=csrfmiddlewaretoken]');
    if (csrfInput) {
        return csrfInput.value;
    }
    // Fallback to meta tag or Django template variable
    const csrfMeta = document.querySelector('meta[name=csrf-token]');
    if (csrfMeta) {
        return csrfMeta.getAttribute('content');
    }
    return 'V7R8kYtZ1wBfZl2MRYtA5agA4aCDKD9Tb4T7ze7jaRZBUOiL630BVsMYzxS6dsad';
}

// Save Assistant Configuration
async function saveAssistantConfig(btn) {
    const originalText = btn.innerHTML;
    
    // Show loading state
    btn.disabled = true;
    btn.innerHTML = '<span class="loading loading-spinner loading-sm mr-2"></span>Saving...';
    
    try {
        console.log('Saving assistant configuration...');
        
        // Get the selected assistant ID from URL
        const currentUrl = new URL(window.location);
        const selectedAssistantId = currentUrl.searchParams.get('selected') || '7d687cd3-5a61-416b-8a7b-d53b7b6c7aba';
        
        if (!selectedAssistantId || selectedAssistantId === 'None') {
            throw new Error('No assistant selected');
        }
        
        // Collect form data
        const configData = {
            model: {
                provider: document.getElementById('model-provider')?.value || '',
                model_name: document.getElementById('model-name')?.value || '',
                first_message_mode: document.getElementById('first-message-mode')?.value || '',
                first_message: document.getElementById('first-message')?.value || '',
                system_prompt: document.getElementById('system-prompt')?.value || '',

            },
            voice: {
                voice_id: document.getElementById('voice-selection')?.value || '',
                ambient_sound_enabled: document.getElementById('ambient-sound-enabled')?.checked || false,
                ambient_sound_type: document.getElementById('ambient-sound-type')?.value || '',
                ambient_sound_volume: document.getElementById('ambient-sound-volume')?.value || '',
                ambient_sound_url: document.getElementById('ambient-sound-url')?.value || '',
                thinking_sound_enabled: document.getElementById('thinking-sound-enabled')?.checked || false,
                thinking_sound_primary: document.getElementById('thinking-sound-primary')?.value || '',
                thinking_sound_primary_volume: document.getElementById('thinking-sound-primary-volume')?.value || '',
                thinking_sound_secondary: document.getElementById('thinking-sound-secondary')?.value || '',
                thinking_sound_secondary_volume: document.getElementById('thinking-sound-secondary-volume')?.value || ''
            },
            privacy: {
                audio_recording: document.getElementById('audio-recording')?.checked || false
            },
            advanced: {
                turn_detection_threshold: document.getElementById('turn-detection-threshold')?.value || '',
                turn_detection_silence_duration_ms: document.getElementById('turn-detection-silence-duration')?.value || '',
                turn_detection_prefix_padding_ms: document.getElementById('turn-detection-prefix-padding')?.value || '',
                turn_detection_create_response: document.getElementById('turn-detection-create-response')?.checked || false,
                turn_detection_interrupt_response: document.getElementById('turn-detection-interrupt-response')?.checked || false
            }
        };
        
        console.log('Configuration data:', configData);
        
        const response = await fetch(`/assistants/00000000-0000-0000-0000-000000000000/save/`.replace('00000000-0000-0000-0000-000000000000', selectedAssistantId), {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken(),
            },
            body: JSON.stringify(configData)
        });
        
        console.log('Response status:', response.status);
        const data = await response.json();
        console.log('Response data:', data);
        
        if (data.success) {
            // Show success message
            const alert = document.createElement('div');
            alert.className = 'alert alert-success fixed top-4 right-4 z-50 max-w-sm';
            alert.innerHTML = `
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
                <span>${data.message}</span>
            `;
            document.body.appendChild(alert);
            
            // Remove alert after 3 seconds
            setTimeout(() => {
                alert.remove();
            }, 3000);
        } else {
            throw new Error(data.error || 'Failed to save configuration');
        }
    } catch (error) {
        console.error('Error saving configuration:', error);
        
        // Show error message
        const alert = document.createElement('div');
        alert.className = 'alert alert-error fixed top-4 right-4 z-50 max-w-sm';
        alert.innerHTML = `
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
            <span>Error: ${error.message}</span>
        `;
        document.body.appendChild(alert);
        
        // Remove alert after 5 seconds
        setTimeout(() => {
            alert.remove();
        }, 5000);
    } finally {
        // Restore button state
        btn.disabled = false;
        btn.innerHTML = originalText;
    }
}

// Create Assistant functionality
async function createAssistant(btn) {
    const originalText = btn.innerHTML;
    
    // Show loading state
    btn.disabled = true;
    btn.innerHTML = '<span class="loading loading-spinner loading-sm mr-2"></span>Creating...';
    
    try {
        console.log('Creating assistant...');
        const response = await fetch('/assistants/create/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': getCSRFToken(),
            },
            body: 'name=Maha'
        });
        
        console.log('Response status:', response.status);
        const data = await response.json();
        console.log('Response data:', data);
        
        if (data.success) {
            // Show success message
            const alert = document.createElement('div');
            alert.className = 'alert alert-success fixed top-4 right-4 z-50 max-w-sm';
            alert.innerHTML = `
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
                <span>${data.message}</span>
            `;
            document.body.appendChild(alert);
            
            // Remove alert after 3 seconds
            setTimeout(() => {
                alert.remove();
            }, 3000);
            
            // Reload page to show new assistant
            setTimeout(() => {
                window.location.reload();
            }, 1500);
        } else {
            throw new Error(data.error || 'Failed to create assistant');
        }
    } catch (error) {
        console.error('Error creating assistant:', error);
        
        // Show error message
        const alert = document.createElement('div');
        alert.className = 'alert alert-error fixed top-4 right-4 z-50 max-w-sm';
        alert.innerHTML = `
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
            <span>Error: ${error.message}</span>
        `;
        document.body.appendChild(alert);
        
        // Remove alert after 5 seconds
        setTimeout(() => {
            alert.remove();
        }, 5000);
    } finally {
        // Restore button state
        btn.disabled = false;
        btn.innerHTML = originalText;
    }
}

// Load assistant details
function selectAssistant(assistantId) {
    console.log('Selecting assistant:', assistantId);
    // Navigate to the same page with selected assistant parameter
    const currentUrl = new URL(window.location);
    currentUrl.searchParams.set('selected', assistantId);
    window.location.href = currentUrl.toString();
}

// Voice data mapping
const VOICE_DATA = {
    openai: [
        { id: 'alloy', name: 'Alloy (OpenAI)' },
        { id: 'ash', name: 'Ash (OpenAI)' },
        { id: 'ballad', name: 'Ballad (OpenAI)' },
        { id: 'coral', name: 'Coral (OpenAI)' },
        { id: 'sage', name: 'Sage (OpenAI)' },
        { id: 'verse', name: 'Verse (OpenAI)' }
    ],
    elevenlabs: [
        { id: 'maha_voice_id', name: 'Maha (ElevenLabs)' },
        { id: 'sarah_voice_id', name: 'Sarah (ElevenLabs)' },
        { id: 'alex_voice_id', name: 'Alex (ElevenLabs)' },
        { id: 'jordan_voice_id', name: 'Jordan (ElevenLabs)' },
        { id: 'casey_voice_id', name: 'Casey (ElevenLabs)' },
        { id: 'riley_voice_id', name: 'Riley (ElevenLabs)' },
        { id: 'morgan_voice_id', name: 'Morgan (ElevenLabs)' },
        { id: 'elliot_voice_id', name: 'Elliot (ElevenLabs)' }
    ]
};

// Update voice selection based on provider
function updateVoiceSelection(provider, currentVoiceId = null) {
    const voiceSelect = document.getElementById('voice-selection');
    if (!voiceSelect) return;
    
    console.log('Updating voice selection for provider:', provider, 'current voice:', currentVoiceId);
    
    // Clear existing options
    voiceSelect.innerHTML = '';
    
    // Get voices for the selected provider
    const voices = VOICE_DATA[provider] || [];
    
    // Add new options
    voices.forEach(voice => {
        const option = document.createElement('option');
        option.value = voice.id;
        option.textContent = voice.name;
        
        // Set as selected if it matches current voice
        if (currentVoiceId && voice.id === currentVoiceId) {
            option.selected = true;
        }
        
        voiceSelect.appendChild(option);
    });
    
    // If no current voice is set, select the first option for OpenAI (Ash) or first for ElevenLabs
    if (!currentVoiceId && voices.length > 0) {
        if (provider === 'openai') {
            // Default to Ash for OpenAI
            const ashOption = voiceSelect.querySelector('option[value="ash"]');
            if (ashOption) {
                ashOption.selected = true;
            } else {
                voiceSelect.selectedIndex = 0;
            }
        } else {
            voiceSelect.selectedIndex = 0;
        }
    }
}

// Handle voice provider change
function handleVoiceProviderChange() {
    const providerSelect = document.getElementById('voice-provider');
    const voiceSelect = document.getElementById('voice-selection');
    
    if (!providerSelect || !voiceSelect) return;
    
    providerSelect.addEventListener('change', function() {
        const selectedProvider = this.value;
        console.log('Voice provider changed to:', selectedProvider);
        updateVoiceSelection(selectedProvider);
    });
}

// Handle audio configuration toggles
function handleAudioConfigurationToggles() {
    // Ambient sound toggle
    const ambientSoundToggle = document.getElementById('ambient-sound-enabled');
    const ambientSoundSettings = document.getElementById('ambient-sound-settings');
    
    if (ambientSoundToggle && ambientSoundSettings) {
        ambientSoundToggle.addEventListener('change', function() {
            ambientSoundSettings.style.display = this.checked ? 'block' : 'none';
            // Update accordion height after showing/hiding settings
            updateAccordionHeight('collapsible-voice-additional-tab-content');
        });
    }
    
    // Thinking sound toggle
    const thinkingSoundToggle = document.getElementById('thinking-sound-enabled');
    const thinkingSoundSettings = document.getElementById('thinking-sound-settings');
    
    if (thinkingSoundToggle && thinkingSoundSettings) {
        thinkingSoundToggle.addEventListener('change', function() {
            thinkingSoundSettings.style.display = this.checked ? 'block' : 'none';
            // Update accordion height after showing/hiding settings
            updateAccordionHeight('collapsible-voice-additional-tab-content');
        });
    }
    
    // Ambient sound type change (show/hide custom URL)
    const ambientSoundType = document.getElementById('ambient-sound-type');
    const ambientSoundUrlContainer = document.getElementById('ambient-sound-url-container');
    
    if (ambientSoundType && ambientSoundUrlContainer) {
        ambientSoundType.addEventListener('change', function() {
            ambientSoundUrlContainer.style.display = this.value === 'custom' ? 'block' : 'none';
            // Update accordion height after showing/hiding custom URL container
            updateAccordionHeight('collapsible-voice-additional-tab-content');
        });
    }
    
    // Add event listeners for any other dynamic content changes that might affect height
    const allAudioToggles = document.querySelectorAll('input[type="checkbox"], select');
    allAudioToggles.forEach(toggle => {
        if (toggle.closest('#collapsible-voice-additional-tab-content')) {
            toggle.addEventListener('change', function() {
                // Small delay to ensure DOM updates are complete
                setTimeout(() => {
                    updateAccordionHeight('collapsible-voice-additional-tab-content');
                }, 50);
            });
        }
    });
}

// Function to update accordion height when content changes
function updateAccordionHeight(accordionId) {
    const accordionContent = document.getElementById(accordionId);
    if (!accordionContent) return;
    
    // Only update height if the accordion is currently expanded
    if (accordionContent.dataset.collapsed === 'false') {
        // Use a small delay to ensure DOM updates are complete
        setTimeout(() => {
            // Force recalculation by temporarily removing maxHeight
            accordionContent.style.maxHeight = 'none';
            
            // Get the new scroll height
            const newHeight = accordionContent.scrollHeight;
            
            // Set the new max height with smooth transition
            accordionContent.style.maxHeight = newHeight + 'px';
            
            // Log for debugging
            console.log(`Updated accordion ${accordionId} height to:`, newHeight);
        }, 10);
    }
}

// Function to force update all expanded accordions (useful for dynamic content changes)
function updateAllExpandedAccordions() {
    const expandedSections = document.querySelectorAll('[data-collapsed="false"]');
    expandedSections.forEach(section => {
        // Temporarily remove maxHeight to force recalculation
        section.style.maxHeight = 'none';
        const newHeight = section.scrollHeight;
        section.style.maxHeight = newHeight + 'px';
    });
}

// Copy to clipboard function
function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(function() {
        // Show success feedback
        const alert = document.createElement('div');
        alert.className = 'alert alert-info fixed top-4 right-4 z-50 max-w-sm';
        alert.innerHTML = `
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
            </svg>
            <span>Copied to clipboard!</span>
        `;
        document.body.appendChild(alert);
        
        setTimeout(() => {
            alert.remove();
        }, 2000);
    });
}

// ============================================================================
// KNOWLEDGE BASE FUNCTIONALITY
// ============================================================================

function initializeKnowledgeBase() {
    console.log('Initializing knowledge base functionality...');
    
    // File upload handling
    const fileUpload = document.getElementById('file-upload');
    if (fileUpload) {
        fileUpload.addEventListener('change', handleFileUpload);
    }
    
    // Add website button
    const addWebsiteBtn = document.getElementById('add-website');
    if (addWebsiteBtn) {
        addWebsiteBtn.addEventListener('click', handleAddWebsite);
    }
    
    // Load initial knowledge base data
    const currentUrl = new URL(window.location);
    let selectedAssistantId = currentUrl.searchParams.get('selected');
    
    // Fallback to template variable if no URL parameter
    if (!selectedAssistantId) {
        const templateAssistantId = '7d687cd3-5a61-416b-8a7b-d53b7b6c7aba';
        selectedAssistantId = templateAssistantId !== '' && templateAssistantId !== 'None' ? templateAssistantId : null;
    }
    
    if (selectedAssistantId && selectedAssistantId !== 'None') {
        loadKnowledgeBaseData(selectedAssistantId);
    }
}

function handleFileUpload(event) {
    const files = event.target.files;
    if (!files.length) return;
    
    // Get the selected assistant ID from URL
    const currentUrl = new URL(window.location);
    let selectedAssistantId = currentUrl.searchParams.get('selected');
    
    // Fallback to template variable if no URL parameter
    if (!selectedAssistantId) {
        const templateAssistantId = '7d687cd3-5a61-416b-8a7b-d53b7b6c7aba';
        selectedAssistantId = templateAssistantId !== '' && templateAssistantId !== 'None' ? templateAssistantId : null;
    }
    
    // Validate that we have a valid UUID format
    const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i;
    if (!selectedAssistantId || selectedAssistantId === 'None' || !uuidRegex.test(selectedAssistantId)) {
        showAlert('Please select an assistant first', 'error');
        return;
    }
    
    const formData = new FormData();
    formData.append('file', files[0]);
    
    // Show loading state
    const fileList = document.getElementById('file-list');
    const loadingItem = createFileItem({
        id: 'loading',
        name: files[0].name,
        size: files[0].size,
        status: 'uploading'
    });
    fileList.appendChild(loadingItem);
    
    // Upload file
    fetch(`/assistants/${selectedAssistantId}/upload-file/`, {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Replace loading item with actual file
            loadingItem.remove();
            const fileItem = createFileItem(data);
            fileList.appendChild(fileItem);
            updateFileCount(fileList.children.length);
        } else {
            loadingItem.remove();
            updateKnowledgeBaseHeight();
            showAlert('Error uploading file: ' + data.error, 'error');
        }
    })
    .catch(error => {
        loadingItem.remove();
        updateKnowledgeBaseHeight();
        showAlert('Error uploading file: ' + error.message, 'error');
    });
    
    // Clear file input
    event.target.value = '';
}

function handleAddWebsite() {
    const urlInput = document.getElementById('website-url');
    const url = urlInput.value.trim();
    
    if (!url) {
        showAlert('Please enter a valid URL', 'error');
        return;
    }
    
    // Get the selected assistant ID from URL
    const currentUrl = new URL(window.location);
    let selectedAssistantId = currentUrl.searchParams.get('selected');
    
    // Fallback to template variable if no URL parameter
    if (!selectedAssistantId) {
        const templateAssistantId = '7d687cd3-5a61-416b-8a7b-d53b7b6c7aba';
        selectedAssistantId = templateAssistantId !== '' && templateAssistantId !== 'None' ? templateAssistantId : null;
    }
    
    // Validate that we have a valid UUID format
    const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i;
    if (!selectedAssistantId || selectedAssistantId === 'None' || !uuidRegex.test(selectedAssistantId)) {
        showAlert('Please select an assistant first', 'error');
        return;
    }
    
    const formData = new FormData();
    formData.append('url', url);
    
    // Show loading state
    const websiteList = document.getElementById('website-list');
    const loadingItem = createWebsiteItem({
        id: 'loading',
        name: 'Loading...',
        url: url,
        status: 'adding'
    });
    websiteList.appendChild(loadingItem);
    
    // Add website
    fetch(`/assistants/${selectedAssistantId}/add-website/`, {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Replace loading item with actual website
            loadingItem.remove();
            const websiteItem = createWebsiteItem(data);
            websiteList.appendChild(websiteItem);
            updateWebsiteCount(websiteList.children.length);
            urlInput.value = '';
        } else {
            loadingItem.remove();
            updateKnowledgeBaseHeight();
            showAlert('Error adding website: ' + data.error, 'error');
        }
    })
    .catch(error => {
        loadingItem.remove();
        updateKnowledgeBaseHeight();
        showAlert('Error adding website: ' + error.message, 'error');
        urlInput.value = '';
    });
}

function createFileItem(file) {
    const item = document.createElement('div');
    item.className = 'flex items-center justify-between p-3 bg-base-200/50 rounded-lg';
    item.innerHTML = `
        <div class="flex items-center space-x-3">
            <svg class="w-5 h-5 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
            </svg>
            <div>
                <div class="font-medium text-sm">${file.name}</div>
                <div class="text-xs text-base-content/60">${formatFileSize(file.size)}</div>
            </div>
        </div>
        <div class="flex items-center space-x-2">
            <span class="badge badge-sm ${getStatusBadgeClass(file.status)}">${file.status}</span>
            <button onclick="deleteFile('${file.id}')" class="btn btn-ghost btn-xs text-error hover:bg-error/10">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                </svg>
            </button>
        </div>
    `;
    return item;
}

function createWebsiteItem(website) {
    const item = document.createElement('div');
    item.className = 'flex items-center justify-between p-3 bg-base-200/50 rounded-lg';
    item.innerHTML = `
        <div class="flex items-center space-x-3">
            <svg class="w-5 h-5 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9"></path>
            </svg>
            <div>
                <div class="font-medium text-sm">${website.name}</div>
                <div class="text-xs text-base-content/60">${website.url}</div>
            </div>
        </div>
        <div class="flex items-center space-x-2">
            <span class="badge badge-sm ${getStatusBadgeClass(website.status)}">${website.status}</span>
            <button onclick="deleteWebsite(${website.id})" class="btn btn-ghost btn-xs text-error hover:bg-error/10">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                </svg>
            </button>
        </div>
    `;
    return item;
}

function deleteFile(fileId) {
    if (!confirm('Are you sure you want to delete this file?')) return;
    
    // Get the selected assistant ID from URL
    const currentUrl = new URL(window.location);
    const selectedAssistantId = currentUrl.searchParams.get('selected') || '7d687cd3-5a61-416b-8a7b-d53b7b6c7aba';
    
    if (!selectedAssistantId || selectedAssistantId === 'None') {
        showAlert('No assistant selected', 'error');
        return;
    }
    
    fetch(`/assistants/${selectedAssistantId}/delete-file/${fileId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Remove file item from DOM
            const fileItem = document.querySelector(`[onclick="deleteFile('${fileId}')"]`).closest('.flex');
            fileItem.remove();
            const fileList = document.getElementById('file-list');
            updateFileCount(fileList.children.length);
        } else {
            showAlert('Error deleting file: ' + data.error, 'error');
        }
    })
    .catch(error => {
        showAlert('Error deleting file: ' + error.message, 'error');
    });
}

function deleteWebsite(websiteId) {
    if (!confirm('Are you sure you want to delete this website?')) return;
    
    // Get the selected assistant ID from URL
    const currentUrl = new URL(window.location);
    const selectedAssistantId = currentUrl.searchParams.get('selected') || '7d687cd3-5a61-416b-8a7b-d53b7b6c7aba';
    
    if (!selectedAssistantId || selectedAssistantId === 'None') {
        showAlert('No assistant selected', 'error');
        return;
    }
    
    fetch(`/assistants/${selectedAssistantId}/delete-website/${websiteId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Remove website item from DOM
            const websiteItem = document.querySelector(`[onclick="deleteWebsite(${websiteId})"]`).closest('.flex');
            websiteItem.remove();
            const websiteList = document.getElementById('website-list');
            updateWebsiteCount(websiteList.children.length);
        } else {
            showAlert('Error deleting website: ' + data.error, 'error');
        }
    })
    .catch(error => {
        showAlert('Error deleting website: ' + error.message, 'error');
    });
}

function loadKnowledgeBaseData(assistantId) {
    if (!assistantId || assistantId === 'None') return;
    
    // Validate UUID format before making request
    const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i;
    if (!uuidRegex.test(assistantId)) {
        console.warn('Invalid assistant ID format:', assistantId);
        return;
    }
    
    fetch(`/assistants/${assistantId}/knowledge-base/`)
    .then(response => response.json())
    .then(data => {
        if (data.success !== false) {
            // Populate file list
            const fileList = document.getElementById('file-list');
            fileList.innerHTML = '';
            data.files.forEach(file => {
                const fileItem = createFileItem(file);
                fileList.appendChild(fileItem);
            });
            
            // Populate website list
            const websiteList = document.getElementById('website-list');
            websiteList.innerHTML = '';
            data.websites.forEach(website => {
                const websiteItem = createWebsiteItem(website);
                websiteList.appendChild(websiteItem);
            });
            
            // Update counts
            updateFileCount(data.file_count);
            updateWebsiteCount(data.website_count);
            
            // Update height after loading data
            setTimeout(() => updateKnowledgeBaseHeight(), 100);
        }
    })
    .catch(error => {
        console.error('Error loading knowledge base data:', error);
    });
}

function updateFileCount(count) {
    const fileCountElement = document.getElementById('file-count');
    if (fileCountElement) {
        fileCountElement.textContent = count || 0;
    }
    // Recalculate knowledge base height after file count changes
    updateKnowledgeBaseHeight();
}

function updateWebsiteCount(count) {
    const websiteCountElement = document.getElementById('website-count');
    if (websiteCountElement) {
        websiteCountElement.textContent = count || 0;
    }
    // Recalculate knowledge base height after website count changes
    updateKnowledgeBaseHeight();
}

function updateKnowledgeBaseHeight() {
    // Update the height of the knowledge base section if it's expanded
    const knowledgeBaseContent = document.getElementById('collapsible-knowledge-base-tab-content');
    if (knowledgeBaseContent && knowledgeBaseContent.dataset.collapsed === 'false') {
        // Force recalculation by temporarily removing maxHeight
        knowledgeBaseContent.style.maxHeight = 'none';
        // Get the new scroll height
        const newHeight = knowledgeBaseContent.scrollHeight;
        // Set the new max height with smooth transition
        knowledgeBaseContent.style.maxHeight = newHeight + 'px';
    }
}

function getStatusBadgeClass(status) {
    switch (status) {
        case 'completed':
        case 'active':
            return 'badge-success';
        case 'pending':
        case 'adding':
            return 'badge-warning';
        case 'failed':
            return 'badge-error';
        case 'uploading':
            return 'badge-info';
        default:
            return 'badge-error';
    }
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

function showAlert(message, type = 'info') {
    const alert = document.createElement('div');
    alert.className = `alert alert-${type} fixed top-4 right-4 z-50 max-w-sm`;
    alert.innerHTML = `
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>
        <span>${message}</span>
    `;
    document.body.appendChild(alert);
    
    setTimeout(() => {
        alert.remove();
    }, 5000);
}

// Initialize when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, initializing...');
    
    // The sidebar utility script will handle fixed header positioning automatically
    
    // Main create button
    const createBtn = document.getElementById('create-assistant-btn');
    if (createBtn) {
        console.log('Found create button');
        createBtn.addEventListener('click', (e) => {
            e.preventDefault();
            createAssistant(createBtn);
        });
    } else {
        console.log('Create button not found');
    }
    
    // Quick create button under search
    const quickCreateBtn = document.getElementById('quick-create-assistant');
    if (quickCreateBtn) {
        console.log('Found quick create button');
        quickCreateBtn.addEventListener('click', (e) => {
            e.preventDefault();
            createAssistant(quickCreateBtn);
        });
    }
    
    // Empty state create button
    const emptyStateBtn = document.getElementById('empty-state-create-btn');
    if (emptyStateBtn) {
        console.log('Found empty state button');
        emptyStateBtn.addEventListener('click', (e) => {
            e.preventDefault();
            createAssistant(emptyStateBtn);
        });
    }
    
    // Save configuration button
    const saveConfigBtn = document.getElementById('save-config-btn');
    if (saveConfigBtn) {
        console.log('Found save config button');
        saveConfigBtn.addEventListener('click', (e) => {
            e.preventDefault();
            saveAssistantConfig(saveConfigBtn);
        });
    }
    
    // Assistant selection functionality
    const assistantItems = document.querySelectorAll('.assistant-item');
    console.log('Found assistant items:', assistantItems.length);
    assistantItems.forEach(item => {
        item.addEventListener('click', function(e) {
            e.preventDefault();
            const assistantId = this.dataset.assistantId;
            console.log('Clicked assistant:', assistantId);
            selectAssistant(assistantId);
        });
    });
    
    // Initialize voice provider change handler
    handleVoiceProviderChange();
    
    // Initialize audio configuration toggles
    handleAudioConfigurationToggles();
    
    // Update accordion height on page load if any audio settings are enabled
    setTimeout(() => {
        updateAccordionHeight('collapsible-voice-additional-tab-content');
    }, 100);
    
    // Also update after a longer delay to ensure all dynamic content is rendered
    setTimeout(() => {
        updateAccordionHeight('collapsible-voice-additional-tab-content');
    }, 500);
    
    // Initialize voice selection based on current configuration
    const voiceProviderSelect = document.getElementById('voice-provider');
    const voiceSelectionSelect = document.getElementById('voice-selection');
    
    if (voiceProviderSelect && voiceSelectionSelect) {
        const currentProvider = voiceProviderSelect.value;
        const currentVoiceId = voiceSelectionSelect.dataset.currentVoice;
        
        console.log('Initializing voice selection with provider:', currentProvider, 'voice:', currentVoiceId);
        
        // Update voice selection to show only voices for current provider
        updateVoiceSelection(currentProvider, currentVoiceId);
    }
    
    // Initialize knowledge base functionality
    initializeKnowledgeBase();
    
    // Add window resize listener to update accordion heights
    window.addEventListener('resize', () => {
        updateAllExpandedAccordions();
    });
    
    // Reload knowledge base data when assistant changes
    const currentUrl = new URL(window.location);
    let selectedAssistantId = currentUrl.searchParams.get('selected');
    
    // Fallback to template variable if no URL parameter
    if (!selectedAssistantId) {
        const templateAssistantId = '7d687cd3-5a61-416b-8a7b-d53b7b6c7aba';
        selectedAssistantId = templateAssistantId !== '' && templateAssistantId !== 'None' ? templateAssistantId : null;
    }
    
    if (selectedAssistantId && selectedAssistantId !== 'None') {
        loadKnowledgeBaseData(selectedAssistantId);
    }
});
</script>

<!-- Add CSRF token for AJAX requests -->
<input type="hidden" name="csrfmiddlewaretoken" value="V7R8kYtZ1wBfZl2MRYtA5agA4aCDKD9Tb4T7ze7jaRZBUOiL630BVsMYzxS6dsad">
