{% comment %}
Standardized Filter Bar Component
Usage: {% include 'components/filter_bar.html' with search_placeholder="Search..." filters=filter_list %}

Parameters:
- search_placeholder: Placeholder text for search input (default: "Search...")
- search_value: Current search value
- filters: List of filter options/buttons
- extra_controls: Additional filter controls (HTML)
- variant: Filter bar style (default, compact, borderless)
- show_search: Show search input (default: true)
- search_name: Name attribute for search input (default: "search")
- form_id: Form ID for the filter form
- class: Additional CSS classes
{% endcomment %}

{% load static %}

<!-- Standardized Filter Bar - Tagged for debugging -->
<div class="filter-bar {% if variant == 'compact' %}py-2{% elif variant == 'borderless' %}border-0 bg-transparent{% endif %} {{ class|default:'' }}"
     data-component="filter-bar" 
     data-variant="{{ variant|default:'default' }}">
  
  <!-- Search Input Section -->
  {% if show_search != False %}
    <div class="filter-bar-search" data-component="filter-search">
      <div class="relative">
        <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
          <svg class="w-4 h-4 text-base-content/50" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
          </svg>
        </div>
        <input type="text" 
               name="{{ search_name|default:'search' }}"
               value="{{ search_value|default:'' }}"
               placeholder="{{ search_placeholder|default:'Search...' }}"
               class="input input-bordered w-full pl-10 pr-4 search-enhanced bg-base-100 border-base-content/20 focus:border-primary focus:outline-none"
               data-element="search-input"
               {% if form_id %}form="{{ form_id }}"{% endif %}>
      </div>
    </div>
  {% endif %}
  
  <!-- Filter Controls Section -->
  <div class="filter-bar-controls" data-component="filter-controls">
    
    <!-- Standard Filter Buttons/Dropdowns -->
    {% if filters %}
      {% for filter in filters %}
        <div class="relative" data-filter-name="{{ filter.name|slugify }}">
          {% if filter.type == 'dropdown' %}
            <!-- Dropdown Filter -->
            <div class="dropdown dropdown-end">
              <div tabindex="0" role="button" class="btn btn-outline btn-sm gap-2">
                {% if filter.icon %}
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                    {% if filter.icon == 'calendar' %}
                      <rect width="18" height="18" x="3" y="4" rx="2" ry="2"/>
                      <line x1="16" y1="2" x2="16" y2="6"/>
                      <line x1="8" y1="2" x2="8" y2="6"/>
                      <line x1="3" y1="10" x2="21" y2="10"/>
                    {% elif filter.icon == 'filter' %}
                      <polygon points="22,3 2,3 10,12.46 10,19 14,21 14,12.46 22,3"/>
                    {% elif filter.icon == 'tag' %}
                      <path d="m15 3 6 6-6 6-6-6 6-6z"/>
                      <path d="m9 9 6 6"/>
                    {% endif %}
                  </svg>
                {% endif %}
                <span>{{ filter.label }}</span>
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                  <path d="m6 9 6 6 6-6"/>
                </svg>
              </div>
              <ul tabindex="0" class="dropdown-content z-[1] menu p-2 shadow-lg bg-base-100 rounded-xl w-52 border border-base-content/10 mt-1">
                {% for option in filter.options %}
                  <li>
                    <a href="{{ option.url }}" 
                       class="flex items-center justify-between{% if option.active %} bg-primary/10 text-primary font-medium{% endif %}">
                      <span>{{ option.label }}</span>
                      {% if option.count %}
                        <div class="badge badge-sm badge-neutral">{{ option.count }}</div>
                      {% endif %}
                    </a>
                  </li>
                {% endfor %}
              </ul>
            </div>
          
          {% elif filter.type == 'button' %}
            <!-- Button Filter -->
            <button type="button" 
                    class="btn btn-sm{% if filter.active %} btn-primary{% else %} btn-outline{% endif %}"
                    onclick="{{ filter.onclick|default:'' }}"
                    data-filter-value="{{ filter.value|default:'' }}">
              {% if filter.icon %}
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                  {% if filter.icon == 'star' %}
                    <polygon points="12,2 15.09,8.26 22,9.27 17,14.14 18.18,21.02 12,17.77 5.82,21.02 7,14.14 2,9.27 8.91,8.26 12,2"/>
                  {% elif filter.icon == 'clock' %}
                    <circle cx="12" cy="12" r="10"/>
                    <polyline points="12,6 12,12 16,14"/>
                  {% endif %}
                </svg>
              {% endif %}
              <span>{{ filter.label }}</span>
              {% if filter.count %}
                <div class="badge badge-sm">{{ filter.count }}</div>
              {% endif %}
            </button>
          {% endif %}
        </div>
      {% endfor %}
    {% endif %}
    
    <!-- Extra Controls -->
    {% if extra_controls %}
      <div class="flex items-center gap-2" data-component="extra-controls">
        {{ extra_controls }}
      </div>
    {% endif %}
    
    <!-- Clear/Reset Filters Button -->
    {% if show_clear_button != False %}
      <button type="button" 
              class="btn btn-ghost btn-sm text-base-content/60 hover:text-base-content"
              onclick="clearFilters()"
              data-action="clear-filters">
        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/>
        </svg>
        Clear
      </button>
    {% endif %}
    
    <!-- View Toggle (List/Grid) -->
    {% if show_view_toggle %}
      <div class="btn-group" data-component="view-toggle">
        <button type="button" 
                class="btn btn-sm btn-outline{% if current_view == 'grid' %} btn-active{% endif %}"
                onclick="setView('grid')"
                data-view="grid">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
            <rect width="7" height="7" x="3" y="3" rx="1"/>
            <rect width="7" height="7" x="14" y="3" rx="1"/>
            <rect width="7" height="7" x="3" y="14" rx="1"/>
            <rect width="7" height="7" x="14" y="14" rx="1"/>
          </svg>
        </button>
        <button type="button" 
                class="btn btn-sm btn-outline{% if current_view == 'list' %} btn-active{% endif %}"
                onclick="setView('list')"
                data-view="list">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
            <line x1="8" y1="6" x2="21" y2="6"/>
            <line x1="8" y1="12" x2="21" y2="12"/>
            <line x1="8" y1="18" x2="21" y2="18"/>
            <line x1="3" y1="6" x2="3.01" y2="6"/>
            <line x1="3" y1="12" x2="3.01" y2="12"/>
            <line x1="3" y1="18" x2="3.01" y2="18"/>
          </svg>
        </button>
      </div>
    {% endif %}
    
  </div>
</div>

<!-- Filter Bar JavaScript -->
<script>
  // Clear all filters function
  function clearFilters() {
    // Clear search input
    const searchInput = document.querySelector('[data-element="search-input"]');
    if (searchInput) {
      searchInput.value = '';
    }
    
    // Reset active filter buttons
    document.querySelectorAll('[data-component="filter-bar"] .btn-primary').forEach(btn => {
      btn.classList.remove('btn-primary');
      btn.classList.add('btn-outline');
    });
    
    // Trigger search/filter update
    if (typeof updateFilters === 'function') {
      updateFilters();
    }
    
    console.log('Filters cleared');
  }
  
  // Set view mode (grid/list)
  function setView(viewType) {
    // Update button states
    document.querySelectorAll('[data-component="view-toggle"] .btn').forEach(btn => {
      btn.classList.remove('btn-active');
    });
    document.querySelector(`[data-view="${viewType}"]`).classList.add('btn-active');
    
    // Store preference
    localStorage.setItem('preferred_view', viewType);
    
    // Trigger view change
    if (typeof changeView === 'function') {
      changeView(viewType);
    }
    
    console.log('View changed to:', viewType);
  }
  
  // Initialize view from localStorage
  document.addEventListener('DOMContentLoaded', function() {
    const savedView = localStorage.getItem('preferred_view');
    if (savedView && document.querySelector(`[data-view="${savedView}"]`)) {
      setView(savedView);
    }
  });
</script>
