{% extends 'base.html' %} {% load static %} {% block title %}Campaign Dashboard
- Watchtower{% endblock %} {% block extra_head %}
<!-- Chart.js for performance charts -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- Real-time updates -->
<script src="https://cdn.jsdelivr.net/npm/htmx.org@1.9.10"></script>
<style>
  .metric-card {
    @apply bg-base-200 rounded-lg p-6 border border-base-300;
  }
  .metric-value {
    @apply text-3xl font-bold text-primary;
  }
  .metric-label {
    @apply text-sm text-base-content/70 uppercase tracking-wide;
  }
  .status-badge {
    @apply badge badge-sm;
  }
  .status-active {
    @apply badge-success;
  }
  .status-draft {
    @apply badge-warning;
  }
  .status-paused {
    @apply badge-info;
  }
  .status-completed {
    @apply badge-neutral;
  }
  .status-cancelled {
    @apply badge-error;
  }
  .queue-status {
    @apply inline-flex items-center px-2 py-1 rounded-full text-xs font-medium;
  }
  .queue-active {
    @apply bg-green-100 text-green-800;
  }
  .queue-idle {
    @apply bg-gray-100 text-gray-800;
  }
  .queue-error {
    @apply bg-red-100 text-red-800;
  }

  .hidden {
    display: none !important;
  }

  #performanceChart,
  #statusChart {
    min-height: 200px;
    width: 100% !important;
  }
</style>
{% endblock %} {% block content %}
<div class="space-y-6">
  <!-- Page header -->
  <div class="flex justify-between items-center">
    <div>
      <h1 class="text-3xl font-bold">Campaign Dashboard</h1>
      <p class="text-base-content/70">
        Real-time monitoring and management of your AI agent campaigns
      </p>
    </div>
    <div class="flex gap-3">
      <a href="{% url 'campaigns:queue_monitor' %}" class="btn btn-outline">
        <svg
          class="w-5 h-5 mr-2"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"
          ></path>
        </svg>
        Queue Monitor
      </a>
      <a
        href="{% url 'campaigns:campaign_create' %}"
        class="btn text-black bg-[#20D5F9] border-[#20D5F9] hover:bg-[#20D5F9]/90 hover:border-[#20D5F9]/90"
      >
        <svg
          class="w-5 h-5 mr-2"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M12 6v6m0 0v6m0-6h6m-6 0H6"
          ></path>
        </svg>
        New Campaign
      </a>
    </div>
  </div>

  <!-- Real-time metrics -->
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
    <!-- Total Campaigns -->
    <div class="metric-card">
      <div class="metric-label">Total Campaigns</div>
      <div class="metric-value">{{ stats.total }}</div>
      <div class="text-sm text-base-content/60 mt-2">
        <span class="text-success">+{{ stats.active }} active</span>
      </div>
    </div>

    <!-- Success Rate -->
    <div class="metric-card">
      <div class="metric-label">Success Rate</div>
      <div class="metric-value">{{ stats.success_rate }}%</div>
      <div class="text-sm text-base-content/60 mt-2">
        {% if stats.total_calls > 0 %} {{ stats.successful_calls }}/{{
        stats.total_calls }} calls {% else %} 0/0 calls {% endif %}
      </div>
    </div>

    <!-- Total Calls -->
    <div class="metric-card">
      <div class="metric-label">Total Calls</div>
      <div class="metric-value">{{ stats.total_calls }}</div>
      <div class="text-sm text-base-content/60 mt-2">
        {% if stats.total_calls > 0 %}
        <span class="text-error">{{ stats.failed_calls }} failed</span>
        {% else %}
        <span class="text-base-content/60">No calls yet</span>
        {% endif %}
      </div>
    </div>

    <!-- Queue Status -->
    <div class="metric-card">
      <div class="metric-label">Queue Status</div>
      <div class="metric-value">{{ queue_status.stream_length }}</div>
      <div class="text-sm text-base-content/60 mt-2">
        <span class="queue-status queue-{{ queue_status.status }}">
          {{ queue_status.status|title }}
        </span>
      </div>
    </div>
  </div>

  <!-- Performance Charts -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <!-- Campaign Performance Over Time -->
    <div class="card bg-base-100 shadow-sm">
      <div class="card-body">
        <h3 class="card-title">Campaign Performance (30 Days)</h3>
        <canvas id="performanceChart" width="400" height="200"></canvas>
        <div
          id="performanceChartFallback"
          class="hidden text-center py-8 text-base-content/60"
        >
          <svg
            class="w-12 h-12 mx-auto mb-4"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"
            ></path>
          </svg>
          <p>No performance data available</p>
          <p class="text-sm">
            Charts will appear when campaigns are created and processed
          </p>
        </div>
      </div>
    </div>

    <!-- Campaign Status Distribution -->
    <div class="card bg-base-100 shadow-sm">
      <div class="card-body">
        <h3 class="card-title">Campaign Status Distribution</h3>
        <canvas id="statusChart" width="400" height="200"></canvas>
        <div
          id="statusChartFallback"
          class="hidden text-center py-8 text-base-content/60"
        >
          <svg
            class="w-12 h-12 mx-auto mb-4"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M9 19v-6a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"
            ></path>
          </svg>
          <p>No campaigns available</p>
          <p class="text-sm">
            Status distribution will appear when campaigns are created
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- Recent Activity -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <!-- Recent Campaigns -->
    <div class="card bg-base-100 shadow-sm">
      <div class="card-body">
        <div class="flex justify-between items-center mb-4">
          <h3 class="card-title">Recent Campaigns</h3>
          <a
            href="{% url 'campaigns:campaign_list' %}"
            class="btn btn-sm btn-ghost"
            >View All</a
          >
        </div>

        {% if recent_campaigns %}
        <div class="space-y-3">
          {% for campaign in recent_campaigns %}
          <div
            class="flex items-center justify-between p-3 bg-base-200 rounded-lg"
          >
            <div class="flex-1">
              <div class="font-medium">{{ campaign.name }}</div>
              <div class="text-sm text-base-content/60">
                {{ campaign.description|truncatechars:50 }}
              </div>
            </div>
            <div class="flex items-center gap-2">
              <span class="status-badge status-{{ campaign.status }}"
                >{{ campaign.status|title }}</span
              >
              <a
                href="{% url 'campaigns:campaign_detail' campaign.id %}"
                class="btn btn-xs btn-ghost"
                >View</a
              >
            </div>
          </div>
          {% endfor %}
        </div>
        {% else %}
        <div class="text-center py-8 text-base-content/60">
          <svg
            class="w-12 h-12 mx-auto mb-4"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"
            ></path>
          </svg>
          <p>No campaigns yet</p>
          <a
            href="{% url 'campaigns:campaign_create' %}"
            class="btn btn-sm btn-primary mt-2"
            >Create First Campaign</a
          >
        </div>
        {% endif %}
      </div>
    </div>

    <!-- Recent Sessions -->
    <div class="card bg-base-100 shadow-sm">
      <div class="card-body">
        <div class="flex justify-between items-center mb-4">
          <h3 class="card-title">Recent Sessions</h3>
          <a
            href="{% url 'campaigns:queue_monitor' %}"
            class="btn btn-sm btn-ghost"
            >View All</a
          >
        </div>

        {% if recent_sessions %}
        <div class="space-y-3">
          {% for session in recent_sessions %}
          <div
            class="flex items-center justify-between p-3 bg-base-200 rounded-lg"
          >
            <div class="flex-1">
              <div class="font-medium">{{ session.campaign.name }}</div>
              <div class="text-sm text-base-content/60">
                {{ session.phone_number }} â€¢ {{ session.created_at|timesince }}
                ago
              </div>
            </div>
            <div class="flex items-center gap-2">
              <span class="status-badge status-{{ session.status }}"
                >{{ session.status|title }}</span
              >
            </div>
          </div>
          {% endfor %}
        </div>
        {% else %}
        <div class="text-center py-8 text-base-content/60">
          <svg
            class="w-12 h-12 mx-auto mb-4"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"
            ></path>
          </svg>
          <p>No sessions yet</p>
        </div>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Active Campaigns -->
  {% if active_campaigns %}
  <div class="card bg-base-100 shadow-sm">
    <div class="card-body">
      <h3 class="card-title">Active Campaigns</h3>
      <div class="overflow-x-auto">
        <table class="table table-zebra w-full">
          <thead>
            <tr>
              <th>Campaign</th>
              <th>Assistant</th>
              <th>Status</th>
              <th>Calls</th>
              <th>Success Rate</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for campaign in active_campaigns %}
            <tr>
              <td>
                <div>
                  <div class="font-medium">{{ campaign.name }}</div>
                  <div class="text-sm text-base-content/60">
                    {{ campaign.description|truncatechars:50 }}
                  </div>
                </div>
              </td>
              <td>
                {% if campaign.assistant %}
                <span class="badge badge-outline"
                  >{{ campaign.assistant.name }}</span
                >
                {% else %}
                <span class="text-base-content/60">No Assistant</span>
                {% endif %}
              </td>
              <td>
                <span class="status-badge status-{{ campaign.status }}"
                  >{{ campaign.status|title }}</span
                >
              </td>
              <td>
                <div class="text-sm">
                  <div>{{ campaign.total_calls }}/{{ campaign.max_calls }}</div>
                  <div class="text-success">
                    {{ campaign.successful_calls }} successful
                  </div>
                </div>
              </td>
              <td>
                <div class="flex items-center gap-2">
                  <div class="w-16 bg-base-300 rounded-full h-2">
                    <div
                      class="bg-success h-2 rounded-full"
                      style="width: {{ campaign.success_rate }}%"
                    ></div>
                  </div>
                  <span class="text-sm">{{ campaign.success_rate }}%</span>
                </div>
              </td>
              <td>
                <div class="flex gap-2">
                  <a
                    href="{% url 'campaigns:campaign_detail' campaign.id %}"
                    class="btn btn-xs btn-ghost"
                    >View</a
                  >
                  <button
                    class="btn btn-xs btn-warning"
                    onclick="pauseCampaign({{ campaign.id }})"
                  >
                    Pause
                  </button>
                  <button
                    class="btn btn-xs btn-error"
                    onclick="stopCampaign({{ campaign.id }})"
                  >
                    Stop
                  </button>
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
  {% endif %}
</div>

<!-- Campaign Action Modals -->
<div id="campaignActionModal" class="modal">
  <div class="modal-box">
    <h3 class="font-bold text-lg">Campaign Action</h3>
    <p id="modalMessage" class="py-4"></p>
    <div class="modal-action">
      <button class="btn" onclick="closeModal()">Cancel</button>
      <button id="confirmAction" class="btn btn-primary">Confirm</button>
    </div>
  </div>
</div>

<script>
  // Debug: Log all data being passed to charts
  console.log('Stats data:', {
    active: {{ stats.active }},
    draft: {{ stats.draft }},
    paused: {{ stats.paused }},
    completed: {{ stats.completed }},
    cancelled: {{ stats.cancelled }},
    total_calls: {{ stats.total_calls }},
    successful_calls: {{ stats.successful_calls }},
    failed_calls: {{ stats.failed_calls }}
  });

  // Performance Chart
  const performanceData = {{ performance_data|safe }};
  console.log('Performance data:', performanceData);

  // Only create chart if we have data
  if (performanceData && performanceData.length > 0) {
    try {
      // Hide fallback, show chart
      document.getElementById('performanceChart').classList.remove('hidden');
      document.getElementById('performanceChartFallback').classList.add('hidden');

      const performanceCtx = document.getElementById('performanceChart').getContext('2d');
      const performanceChart = new Chart(performanceCtx, {
      type: 'line',
      data: {
          labels: performanceData.map(item => item.date),
          datasets: [{
              label: 'Success Rate (%)',
              data: performanceData.map(item => item.success_rate),
              borderColor: '#20D5F9',
              backgroundColor: 'rgba(32, 213, 249, 0.1)',
              tension: 0.4
          }]
      },
      options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
              y: {
                  beginAtZero: true,
                  max: 100
              }
          }
      }
    });
    } catch (error) {
      console.error('Error creating performance chart:', error);
      // Show fallback, hide chart
      document.getElementById('performanceChart').classList.add('hidden');
      document.getElementById('performanceChartFallback').classList.remove('hidden');
    }
  } else {
    console.log('No performance data available for chart');
    // Show fallback, hide chart
    document.getElementById('performanceChart').classList.add('hidden');
    document.getElementById('performanceChartFallback').classList.remove('hidden');
  }

  // Status Distribution Chart
  const statusData = [
      {{ stats.active }},
      {{ stats.draft }},
      {{ stats.paused }},
      {{ stats.completed }},
      {{ stats.cancelled }}
  ];
  console.log('Status data:', statusData);

  // Only create chart if we have data
  if (statusData.some(value => value > 0)) {
    try {
      // Hide fallback, show chart
      document.getElementById('statusChart').classList.remove('hidden');
      document.getElementById('statusChartFallback').classList.add('hidden');

      const statusCtx = document.getElementById('statusChart').getContext('2d');
      const statusChart = new Chart(statusCtx, {
      type: 'doughnut',
      data: {
          labels: ['Active', 'Draft', 'Paused', 'Completed', 'Cancelled'],
          datasets: [{
              data: [
                  {{ stats.active }},
                  {{ stats.draft }},
                  {{ stats.paused }},
                  {{ stats.completed }},
                  {{ stats.cancelled }}
              ],
              backgroundColor: [
                  '#10B981', // success
                  '#F59E0B', // warning
                  '#3B82F6', // info
                  '#6B7280', // neutral
                  '#EF4444'  // error
              ]
          }]
      },
      options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
              legend: {
                  position: 'bottom'
              }
          }
      }
    });
    } catch (error) {
      console.error('Error creating status chart:', error);
      // Show fallback, hide chart
      document.getElementById('statusChart').classList.add('hidden');
      document.getElementById('statusChartFallback').classList.remove('hidden');
    }
  } else {
    console.log('No status data available for chart');
    // Show fallback, hide chart
    document.getElementById('statusChart').classList.add('hidden');
    document.getElementById('statusChartFallback').classList.remove('hidden');
  }

  // Campaign Actions
  function pauseCampaign(campaignId) {
      showModal('Are you sure you want to pause this campaign?', () => {
          performCampaignAction(campaignId, 'pause');
      });
  }

  function stopCampaign(campaignId) {
      showModal('Are you sure you want to stop this campaign? This action cannot be undone.', () => {
          performCampaignAction(campaignId, 'stop');
      });
  }

  function performCampaignAction(campaignId, action) {
      fetch(`/campaigns/${campaignId}/action/`, {
          method: 'POST',
          headers: {
              'Content-Type': 'application/x-www-form-urlencoded',
              'X-CSRFToken': getCookie('csrftoken')
          },
          body: `action=${action}`
      })
      .then(response => response.json())
      .then(data => {
          if (data.success) {
              location.reload();
          } else {
              alert('Error: ' + data.error);
          }
      })
      .catch(error => {
          console.error('Error:', error);
          alert('An error occurred while performing the action.');
      });
  }

  // Modal functions
  function showModal(message, onConfirm) {
      document.getElementById('modalMessage').textContent = message;
      document.getElementById('confirmAction').onclick = onConfirm;
      document.getElementById('campaignActionModal').classList.add('modal-open');
  }

  function closeModal() {
      document.getElementById('campaignActionModal').classList.remove('modal-open');
  }

  // Utility functions
  function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
          const cookies = document.cookie.split(';');
          for (let i = 0; i < cookies.length; i++) {
              const cookie = cookies[i].trim();
              if (cookie.substring(0, name.length + 1) === (name + '=')) {
                  cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                  break;
              }
          }
      }
      return cookieValue;
  }

  // Auto-refresh every 30 seconds
  setInterval(() => {
      // Refresh queue status
      fetch('/campaigns/api/queue-status/')
          .then(response => response.json())
          .then(data => {
              // Update queue status display
              const queueStatus = document.querySelector('.queue-status');
              if (queueStatus) {
                  queueStatus.textContent = data.status;
                  queueStatus.className = `queue-status queue-${data.status}`;
              }
          })
          .catch(error => console.error('Error refreshing queue status:', error));
  }, 30000);

  // Initialize chart visibility on page load
  document.addEventListener('DOMContentLoaded', function() {
    // Initialize chart visibility
    if (performanceData && performanceData.length > 0) {
      document.getElementById('performanceChart').classList.remove('hidden');
      document.getElementById('performanceChartFallback').classList.add('hidden');
    } else {
      document.getElementById('performanceChart').classList.add('hidden');
      document.getElementById('performanceChartFallback').classList.remove('hidden');
    }

    if (statusData.some(value => value > 0)) {
      document.getElementById('statusChart').classList.remove('hidden');
      document.getElementById('statusChartFallback').classList.add('hidden');
    } else {
      document.getElementById('statusChart').classList.add('hidden');
      document.getElementById('statusChartFallback').classList.remove('hidden');
    }
  });
</script>
{% endblock %}
