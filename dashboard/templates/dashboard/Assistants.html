{% extends 'base.html' %}
{% load static %}
{% block title %}Assistants - Watchtower{% endblock %}

{% block secondary_sidebar %}
<!-- Secondary Sidebar for Assistants -->
<aside class="w-80 bg-base-200 border-r border-base-content/10 flex flex-col">
  <!-- Header with Title and Docs Button -->
  <div class="flex items-center justify-between px-4 py-4 border-b border-base-content/10">
    <div class="flex items-center space-x-2">
      <svg class="w-5 h-5 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
      </svg>
      <h2 class="text-lg font-semibold text-base-content">Assistants</h2>
    </div>
    <button class="btn btn-ghost btn-sm">
      <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
      </svg>
      Docs
    </button>
  </div>



  <!-- Search Box -->
  <div class="px-4 py-2">
    <div class="relative">
      <input type="text" placeholder="Search Assistants" class="input input-sm w-full bg-base-300/50 border-none text-sm pl-8">
      <svg class="w-4 h-4 absolute left-2 top-1/2 transform -translate-y-1/2 text-base-content/60" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
      </svg>
    </div>
  </div>

  <!-- Quick Create Assistant Option -->
  <div class="px-4 py-2">
    <button id="quick-create-assistant" class="w-full p-2 text-left hover:bg-base-300/50 rounded-lg transition-colors group">
      <div class="flex items-center space-x-2">
        <div class="w-8 h-8 bg-primary/20 rounded-lg flex items-center justify-center group-hover:bg-primary/30 transition-colors">
          <svg class="w-4 h-4 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
          </svg>
        </div>
        <div>
          <div class="text-sm font-medium text-base-content">Create Assistant</div>
          <div class="text-xs text-base-content/60">Start with "Maha" template</div>
        </div>
      </div>
    </button>
  </div>

  <!-- Assistants List -->
  <div class="flex-1 px-4 py-2 overflow-y-auto">
    {% if assistants %}
      <div class="space-y-1">
        {% for assistant in assistants %}
          <div class="p-3 rounded-lg {% if assistant.selected %}bg-primary/20 border border-primary/30{% else %}hover:bg-base-300/50{% endif %} cursor-pointer transition-colors assistant-item" data-assistant-id="{{ assistant.id }}">
            <div class="flex items-center justify-between">
              <div class="flex-1 min-w-0">
                <h3 class="font-medium {% if assistant.selected %}text-primary{% else %}text-base-content/90{% endif %} text-sm truncate">{{ assistant.name }}</h3>
                <p class="text-xs {% if assistant.selected %}text-primary/70{% else %}text-base-content/60{% endif %} truncate">{{ assistant.description|default:"AI Assistant" }}</p>
              </div>
              <div class="w-2 h-2 {% if assistant.is_active %}bg-primary{% else %}bg-base-content/30{% endif %} rounded-full flex-shrink-0"></div>
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <!-- Empty State -->
      <div class="flex flex-col items-center justify-center h-48 text-center">
        <svg class="w-12 h-12 text-base-content/30 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
        </svg>
        <h3 class="text-base-content/60 font-medium mb-2">No assistants yet</h3>
        <p class="text-base-content/40 text-sm">Create your first AI assistant to get started</p>
      </div>
    {% endif %}
  </div>
</aside>
{% endblock %}

{% block content %}
<!-- Fixed Header -->
<div id="assistants-fixed-header" class="fixed top-0 z-50 bg-neutral text-neutral-content border-b border-neutral-content/20 px-6 py-3" style="left: 640px; right: 0;">
  <div class="flex items-center justify-between">
    <!-- Left: Assistant Name & Status -->
    <div class="flex items-center space-x-3">
      {% if selected_assistant %}
        <h1 id="assistant-name" class="text-lg font-bold text-white">{{ selected_assistant.name }}</h1>
        <div class="badge {% if selected_assistant.status == 'published' %}badge-success{% elif selected_assistant.status == 'draft' %}badge-warning{% else %}badge-ghost{% endif %} badge-sm gap-1">
          <div class="w-2 h-2 {% if selected_assistant.status == 'published' %}bg-green-400{% elif selected_assistant.status == 'draft' %}bg-yellow-400{% else %}bg-gray-400{% endif %} rounded-full"></div>
          {{ selected_assistant.status|title }}
        </div>
        <span id="assistant-external-id" class="text-sm text-neutral-content/60 font-mono">{{ selected_assistant.external_id|slice:":20" }}...</span>
        <button class="btn btn-ghost btn-xs text-neutral-content/70 hover:text-white" onclick="copyToClipboard('{{ selected_assistant.external_id }}')">
          <!-- Lucide Copy icon -->
          <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
            <rect width="14" height="14" x="8" y="8" rx="2" ry="2"/>
            <path d="m4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/>
          </svg>
        </button>
      {% else %}
        <h1 class="text-lg font-bold text-white">No Assistant Selected</h1>
        <div class="badge badge-ghost badge-sm gap-1">
          <div class="w-2 h-2 bg-gray-400 rounded-full"></div>
          None
        </div>
      {% endif %}
    </div>
    
    <!-- Right: Segmented Controls + Primary Button -->
    <div class="flex items-center space-x-4">
      <!-- Segmented Control Group -->
      <div class="join bg-white/10 rounded-2xl p-1">
        <button class="join-item btn btn-ghost btn-sm text-neutral-content/80 hover:text-white hover:bg-white/20 border-0 rounded-xl">
          <!-- Lucide Code icon -->
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
            <polyline points="16,18 22,12 16,6"/>
            <polyline points="8,6 2,12 8,18"/>
          </svg>
          Code
        </button>
        <button class="join-item btn btn-ghost btn-sm text-neutral-content/80 hover:text-white hover:bg-white/20 border-0 rounded-xl">
          <!-- Lucide TestTube icon -->
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
            <path d="m7 10 5 5 5-5"/>
            <path d="m12 15 5-5 5 5"/>
          </svg>
          Test
        </button>
        <button class="join-item btn btn-ghost btn-sm text-neutral-content/80 hover:text-white hover:bg-white/20 border-0 rounded-xl">
          <!-- Lucide MessageSquare icon -->
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
          </svg>
          Chat
        </button>
        <button class="join-item btn btn-ghost btn-sm text-white bg-white/20 border-0 rounded-xl">
          <!-- Lucide Phone icon -->
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
            <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/>
          </svg>
          Call
        </button>
      </div>
      
      <!-- Save Configuration Button -->
      {% if selected_assistant %}
      <button id="save-config-btn" class="btn btn-sm bg-[#20D5F9] hover:bg-[#20D5F9]/80 text-black border-0 rounded-xl shadow-lg hover:shadow-xl transition-all duration-300">
        <!-- Lucide Save icon -->
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
          <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
          <polyline points="17,21 17,13 7,13 7,21"/>
          <polyline points="7,3 7,8 15,8"/>
        </svg>
        Save
      </button>
      {% endif %}
      
    </div>
  </div>
  
  <!-- Bottom Tabs Row -->
  <div class="flex items-center justify-between mt-3 border-t border-neutral-content/20 pt-3">
    <!-- Main Navigation Tabs -->
    <div class="flex items-center space-x-8">
      <a href="#model-section" class="relative flex items-center space-x-2 text-neutral-content/70 hover:text-white pb-2 text-sm transition-colors" data-section="model">
        <!-- Lucide Lightbulb icon -->
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
          <path d="m15 14 5-5-5-5"/>
          <path d="m20 9H9"/>
          <path d="M5 19v-8a8.38 8.38 0 0 1 .9-3.8 8.5 8.5 0 0 1 7.6-4.7 8.38 8.38 0 0 1 3.8.9"/>
        </svg>
        <span>Model</span>
      </a>
      <a href="#knowledge-base-section" class="relative flex items-center space-x-2 text-neutral-content/70 hover:text-white pb-2 text-sm transition-colors" data-section="knowledge-base">
        <!-- Lucide Type icon -->
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
          <polyline points="4,7 4,4 20,4 20,7"/>
          <line x1="9" y1="20" x2="15" y2="20"/>
          <line x1="12" y1="4" x2="12" y2="20"/>
        </svg>
        <span>Knowledge Base</span>
      </a>
      <a href="#voice-section" class="relative flex items-center space-x-2 text-neutral-content/70 hover:text-white pb-2 text-sm transition-colors" data-section="voice">
        <!-- Lucide Mic icon -->
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
          <path d="m12 1 0 6 m-3 7c0 3 2.755 5.7 5.5 6-.35.5-.5 1-.5 1.5a2 2 0 0 1-4 0c0-.5-.15-1-.5-1.5 2.745-.3 5.5-3 5.5-6z"/>
          <path d="m19 10c0 1.5-2 5.5-7 5.5s-7-4-7-5.5"/>
          <path d="m12 16v4"/>
          <path d="m8 20l8 0"/>
        </svg>
        <span>Voice & Persona</span>
      </a>
      <a href="#privacy-section" class="relative flex items-center space-x-2 text-neutral-content/70 hover:text-white pb-2 text-sm transition-colors" data-section="privacy">
        <!-- Lucide Shield icon -->
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
          <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
        </svg>
        <span>Privacy</span>
      </a>
      
      <a href="#tools-section" class="relative flex items-center space-x-2 text-neutral-content/70 hover:text-white pb-2 text-sm transition-colors" data-section="tools">
        <!-- Lucide Wrench icon -->
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
          <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/>
        </svg>
        <span>Connected Tools</span>
      </a>
      <a href="#analysis-section" class="relative flex items-center space-x-2 text-neutral-content/70 hover:text-white pb-2 text-sm transition-colors" data-section="analysis">
        <!-- Lucide BarChart3 icon -->
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
          <path d="M3 3v18h18"/>
          <path d="m19 9-5 5-4-4-3 3"/>
        </svg>
        <span>Analytics</span>
      </a>
    </div>
    
  </div>
</div>

<!-- Scrollable Content -->
<div class="space-y-6 content-with-fixed-header">

{% if selected_assistant %}
  <!-- Metrics Strip -->
  {% if metrics %}
  <div class="grid grid-cols-4 gap-3">
    <!-- Cost/min Tile -->
    <div class="bg-gradient-to-br from-cyan-50 to-cyan-100 dark:from-cyan-900/20 dark:to-cyan-800/20 rounded-2xl p-4 border border-cyan-200/50 dark:border-cyan-700/50 cursor-pointer hover:shadow-lg transition-all">
      <div class="flex items-center justify-between mb-2">
        <div class="text-xs font-medium text-cyan-700 dark:text-cyan-300 uppercase tracking-wider">Cost/min</div>
        <div class="w-2 h-2 rounded-full bg-cyan-500"></div>
      </div>
      <div class="text-xl font-bold text-cyan-900 dark:text-cyan-100">${{ metrics.cost_per_minute|floatformat:2 }}</div>
      <div class="text-xs text-cyan-600/80 dark:text-cyan-400/80">Web calls</div>
    </div>
    
    <!-- Avg Latency Tile -->
    <div class="bg-gradient-to-br from-amber-50 to-amber-100 dark:from-amber-900/20 dark:to-amber-800/20 rounded-2xl p-4 border border-amber-200/50 dark:border-amber-700/50 cursor-pointer hover:shadow-lg transition-all">
      <div class="flex items-center justify-between mb-2">
        <div class="text-xs font-medium text-amber-700 dark:text-amber-300 uppercase tracking-wider">Avg Latency</div>
        <div class="w-2 h-2 rounded-full bg-amber-500"></div>
      </div>
      <div class="text-xl font-bold text-amber-900 dark:text-amber-100">{{ metrics.avg_latency|floatformat:2 }}s</div>
      <div class="text-xs text-amber-600/80 dark:text-amber-400/80">Response time</div>
    </div>
    
    <!-- Call Success Tile -->
    <div class="bg-gradient-to-br from-emerald-50 to-emerald-100 dark:from-emerald-900/20 dark:to-emerald-800/20 rounded-2xl p-4 border border-emerald-200/50 dark:border-emerald-700/50 cursor-pointer hover:shadow-lg transition-all">
      <div class="flex items-center justify-between mb-2">
        <div class="text-xs font-medium text-emerald-700 dark:text-emerald-300 uppercase tracking-wider">Call Success</div>
        <div class="w-2 h-2 rounded-full bg-emerald-500"></div>
      </div>
      <div class="text-xl font-bold text-emerald-900 dark:text-emerald-100">{{ metrics.call_success|floatformat:1 }}%</div>
      <div class="text-xs text-emerald-600/80 dark:text-emerald-400/80">Success rate</div>
    </div>
    
    <!-- ASR WER Tile -->
    <div class="bg-gradient-to-br from-violet-50 to-violet-100 dark:from-violet-900/20 dark:to-violet-800/20 rounded-2xl p-4 border border-violet-200/50 dark:border-violet-700/50 cursor-pointer hover:shadow-lg transition-all">
      <div class="flex items-center justify-between mb-2">
        <div class="text-xs font-medium text-violet-700 dark:text-violet-300 uppercase tracking-wider">ASR WER</div>
        <div class="w-2 h-2 rounded-full bg-violet-500"></div>
      </div>
      <div class="text-xl font-bold text-violet-900 dark:text-violet-100">{{ metrics.asr_wer|floatformat:1 }}%</div>
      <div class="text-xs text-violet-600/80 dark:text-violet-400/80">Error rate</div>
    </div>
  </div>
  {% endif %}

  <!-- MODEL Section Divider -->
  <div id="model-section" class="flex items-center space-x-3 text-sm text-base-content/60 uppercase tracking-wider font-semibold">
    <!-- Lucide Brain icon -->
    <svg class="w-5 h-5 text-cyan-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
      <path d="M12 2a10 10 0 1 0 10 10 4 4 0 0 1-5-5 4 4 0 0 1-5-5"/>
      <path d="M8.5 8.5a4 4 0 0 1 6 6"/>
      <path d="M12 2v2"/>
      <path d="m15.5 6.5 1.5-1.5"/>
    </svg>
    <span class="text-base-content/80">MODEL CONFIGURATION</span>
  </div>

  <!-- MODEL (Voysera-style collapsible) -->
  <section class="rounded-lg border border-base-content/10 bg-base-100 overflow-hidden">
    <!-- Header button -->
    <button type="button" aria-controls="collapsible-model-tab-content" aria-expanded="false" data-state="closed" class="group flex w-full flex-row items-center justify-between bg-base-200/40 p-4">
      <div class="flex flex-row items-start gap-3">
        <!-- Section icon -->
        <svg class="w-4 h-4 text-cyan-500 mt-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
        </svg>

        <!-- Title + helper -->
        <div class="flex flex-col items-start">
          <div class="flex flex-row items-center">
            <h2 class="text-lg font-medium text-base-content" data-testid="model-header">AI Model & Behavior</h2>
            <!-- Hover-only helper icon -->
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 256 256" class="ml-2 cursor-pointer text-base-content/50 opacity-0 transition-opacity group-hover:opacity-100">
              <path fill="currentColor" d="M240,88.23a54.43,54.43,0,0,1-16,37L189.25,160a54.27,54.27,0,0,1-38.63,16h-.05A54.63,54.63,0,0,1,96,119.84a8,8,0,0,1,16,.45A38.62,38.62,0,0,0,150.58,160h0a38.39,38.39,0,0,0,27.31-11.31l34.75-34.75a38.63,38.63,0,0,0-54.63-54.63l-11,11A8,8,0,0,1,135.7,59l11-11A54.65,54.65,0,0,1,224,48,54.86,54.86,0,0,1,240,88.23ZM109,185.66l-11,11A38.41,38.41,0,0,1,70.6,208h0a38.63,38.63,0,0,1-27.29-65.94L78,107.31A38.63,38.63,0,0,1,144,135.71a8,8,0,0,0,16,.45A54.86,54.86,0,0,0,144,96a54.65,54.65,0,0,0-77.27,0L32,130.75A54.62,54.62,0,0,0,70.56,224h0a54.28,54.28,0,0,0,38.64-16l11-11A8,8,0,0,0,109,185.66Z"></path>
            </svg>
          </div>
          <p class="text-xs text-base-content/60 text-left">Configure your assistant's intelligence and conversational behavior</p>
        </div>
      </div>

      <!-- Right chevron: rotates when expanded -->
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" aria-hidden="true" class="h-6 w-6 transform transition-transform duration-200 group-aria-expanded:rotate-180">
        <path fill="currentColor" d="M213.66,101.66l-80,80a8,8,0,0,1-11.32,0l-80-80A8,8,0,0,1,53.66,90.34L128,164.69l74.34-74.35a8,8,0,0,1,11.32,11.32Z"></path>
      </svg>
    </button>

    <!-- Collapsible content -->
    <div id="collapsible-model-tab-content" class="overflow-hidden transition-all duration-300 ease-in-out max-h-0" data-collapsed="true">
      <div class="p-4 space-y-3">
        <!-- Provider and Model Row -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <!-- Provider -->
        <div class="space-y-2">
          <label class="flex items-center space-x-2 text-sm font-medium text-base-content">
            <span>Provider</span>
          </label>
          <select id="model-provider" class="select select-bordered w-full bg-base-200/50">
            <option value="azure_openai" {% if assistant_config.model.provider == 'azure_openai' %}selected{% endif %}>Azure OpenAI</option>
          </select>
        </div>

        <!-- Model -->
        <div class="space-y-2">
          <label class="flex items-center space-x-2 text-sm font-medium text-base-content">
            <span>Model</span>
            <div class="relative group">
              <svg class="w-4 h-4 text-base-content/50 cursor-help hover:text-primary transition-colors duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
              <!-- Custom Tooltip -->
              <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-3 py-2 bg-gradient-to-r from-primary to-secondary text-primary-content text-xs rounded-lg shadow-lg opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-300 ease-out group-hover:scale-105 z-50 w-64">
                <div class="relative">
                  Choose the AI model that will power your assistant. Different models have varying capabilities, response quality, and cost.
                  <!-- Arrow -->
                  <div class="absolute top-full left-1/2 transform -translate-x-1/2 w-0 h-0 border-l-4 border-r-4 border-t-4 border-transparent border-t-primary"></div>
                </div>
              </div>
            </div>
          </label>
          <select id="model-name" class="select select-bordered w-full bg-base-200/50">
            <option value="gpt-4o-realtime" {% if assistant_config.model.model_name == 'gpt-4o-realtime' or not assistant_config.model.model_name %}selected{% endif %}>gpt-4o-realtime</option>
            <option value="gpt-4o-mini-realtime" {% if assistant_config.model.model_name == 'gpt-4o-mini-realtime' %}selected{% endif %}>gpt-4o-mini-realtime</option>
            <option value="gpt-4" {% if assistant_config.model.model_name == 'gpt-4' %}selected{% endif %}>gpt-4</option>
            <option value="gpt-3.5-turbo" {% if assistant_config.model.model_name == 'gpt-3.5-turbo' %}selected{% endif %}>gpt-3.5-turbo</option>
          </select>
        </div>
      </div>

      <!-- First Message Mode -->
      <div class="space-y-2">
        <label class="flex items-center space-x-2 text-sm font-medium text-base-content">
          <span>First Message Mode</span>
          <div class="relative group">
            <svg class="w-4 h-4 text-base-content/50 cursor-help hover:text-secondary transition-colors duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <!-- Custom Tooltip -->
            <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-3 py-2 bg-gradient-to-r from-secondary to-accent text-secondary-content text-xs rounded-lg shadow-xl opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-300 ease-out group-hover:scale-105 z-50 w-64">
              <div class="relative">
                Determines who speaks first when the call begins. 'Assistant speaks first' means your AI will greet the caller immediately.
                <!-- Arrow -->
                <div class="absolute top-full left-1/2 transform -translate-x-1/2 w-0 h-0 border-l-4 border-r-4 border-t-4 border-transparent border-t-secondary"></div>
              </div>
            </div>
          </div>
        </label>
        <select id="first-message-mode" class="select select-bordered w-full bg-base-200/50">
          <option value="assistant_speaks_first" {% if assistant_config.model.first_message_mode == 'assistant_speaks_first' or not assistant_config.model.first_message_mode %}selected{% endif %}>Assistant speaks first</option>
          <option value="user_speaks_first" {% if assistant_config.model.first_message_mode == 'user_speaks_first' %}selected{% endif %}>User speaks first</option>
          <option value="both_speak" {% if assistant_config.model.first_message_mode == 'both_speak' %}selected{% endif %}>Both speak</option>
        </select>
      </div>

      <!-- First Message -->
      <div class="space-y-2">
        <label class="flex items-center space-x-2 text-sm font-medium text-base-content">
          <span>First Message</span>
          <div class="relative group">
            <svg class="w-4 h-4 text-base-content/50 cursor-help hover:text-accent transition-colors duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <!-- Custom Tooltip -->
            <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-3 py-2 bg-gradient-to-r from-accent to-info text-accent-content text-xs rounded-lg shadow-xl opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-300 ease-out group-hover:scale-105 z-50 w-64">
              <div class="relative">
                The exact message your assistant will say when the call begins. This should be a warm, professional greeting that sets the tone for the conversation.
                <!-- Arrow -->
                <div class="absolute top-full left-1/2 transform -translate-x-1/2 w-0 h-0 border-l-4 border-r-4 border-t-4 border-transparent border-t-accent"></div>
              </div>
            </div>
          </div>
        </label>
        <input id="first-message" type="text" class="input input-bordered w-full bg-base-200/50" value="{% if assistant_config.model.first_message %}{{ assistant_config.model.first_message }}{% else %}Thank you for calling Wellness Partners. This is Riley, your scheduling assistant. How may I help you today?{% endif %}" />
      </div>

      <!-- System Prompt -->
      <div class="space-y-2">
        <label class="flex items-center justify-between text-sm font-medium text-base-content">
          <div class="flex items-center space-x-2">
            <span>System Prompt</span>
            <div class="relative group">
              <svg class="w-4 h-4 text-base-content/50 cursor-help hover:text-info transition-colors duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
              <!-- Custom Tooltip -->
              <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-4 py-3 bg-gradient-to-br from-info via-info to-primary text-info-content text-xs rounded-xl shadow-2xl opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-300 ease-out group-hover:scale-105 z-50 w-72">
                <div class="relative">
                  <div class="flex items-center mb-1">
                    <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                    </svg>
                    <span class="font-semibold">System Prompt</span>
                  </div>
                  Instructions that define your assistant's personality, behavior, and knowledge. This tells the AI how to act, what it knows, and how to respond to different situations.
                  <!-- Arrow -->
                  <div class="absolute top-full left-1/2 transform -translate-x-1/2 w-0 h-0 border-l-4 border-r-4 border-t-4 border-transparent border-t-info"></div>
                </div>
              </div>
            </div>
          </div>
          <button class="btn btn-primary btn-sm">
            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4"></path>
            </svg>
            Generate
          </button>
        </label>
        <textarea id="system-prompt" class="textarea textarea-bordered w-full bg-base-200/50 h-32 resize-none" placeholder="Add your prompt here...">{% if assistant_config.model.system_prompt %}{{ assistant_config.model.system_prompt }}{% endif %}</textarea>
      </div>


      </div>
    </div>
  </section>

              {% if selected_assistant %}
            <!-- KNOWLEDGE BASE Section Divider -->
            <div id="knowledge-base-section" class="flex items-center space-x-3 text-sm text-base-content/60 uppercase tracking-wider font-semibold">
              <svg class="w-5 h-5 text-cyan-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"></path>
              </svg>
              <span class="text-base-content/80">KNOWLEDGE BASE</span>
            </div>

  <!-- Knowledge Base Configuration subsection -->
  <section class="rounded-lg border border-base-content/10 bg-base-100 overflow-hidden">
    <!-- Header button -->
    <button
      type="button"
      aria-controls="collapsible-knowledge-base-tab-content"
      aria-expanded="false"
      data-state="closed"
      class="group flex w-full flex-row items-center justify-between bg-base-200/40 p-4"
    >
      <div class="flex flex-row items-start gap-3">
        <!-- Section icon -->
        <svg class="w-4 h-4 text-primary mt-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"></path>
        </svg>

        <!-- Title + helper -->
        <div class="flex flex-col items-start">
          <div class="flex flex-row items-center">
            <h2 class="text-lg font-medium text-base-content" data-testid="knowledge-base-header">Knowledge Base</h2>
            <!-- Hover-only helper icon -->
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 256 256"
                 class="ml-2 cursor-pointer text-base-content/50 opacity-0 transition-opacity group-hover:opacity-100">
              <path fill="currentColor"
                d="M240,88.23a54.43,54.43,0,0,1-16,37L189.25,160a54.27,54.27,0,0,1-38.63,16h-.05A54.63,54.63,0,0,1,96,119.84a8,8,0,0,1,16,.45A38.62,38.62,0,0,0,150.58,160h0a38.39,38.39,0,0,0,27.31-11.31l34.75-34.75a38.63,38.63,0,0,0-54.63-54.63l-11,11A8,8,0,0,1,135.7,59l11-11A54.65,54.65,0,0,1,224,48,54.86,54.86,0,0,1,240,88.23ZM109,185.66l-11,11A38.41,38.41,0,0,1,70.6,208h0a38.63,38.63,0,0,1-27.29-65.94L78,107.31A38.63,38.63,0,0,1,144,135.71a8,8,0,0,0,16,.45A54.86,54.86,0,0,0,144,96a54.65,54.65,0,0,0-77.27,0L32,130.75A54.62,54.62,0,0,0,70.56,224h0a54.28,54.28,0,0,0,38.64-16l11-11A8,8,0,0,0,109,185.66Z"/>
            </svg>
          </div>
          <p class="text-xs text-base-content/60 text-left">Upload files and add websites to enhance your assistant's knowledge with RAG capabilities</p>
        </div>
      </div>

      <!-- Right chevron: rotates when expanded -->
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" aria-hidden="true"
           class="h-6 w-6 transform transition-transform duration-200 group-aria-expanded:rotate-180">
        <path fill="currentColor"
          d="M213.66,101.66l-80,80a8,8,0,0,1-11.32,0l-80-80A8,8,0,0,1,53.66,90.34L128,164.69l74.34-74.35a8,8,0,0,1,11.32,11.32Z"/>
      </svg>
    </button>

    <!-- Collapsible content -->
    <div id="collapsible-knowledge-base-tab-content" class="overflow-hidden transition-all duration-300 ease-in-out max-h-0" data-collapsed="true">
      <div class="p-4 space-y-6">
        
        <!-- File Upload Section -->
        <div class="space-y-4">
          <h3 class="text-md font-medium text-base-content">File Uploads</h3>
          <div class="border-2 border-dashed border-base-content/20 rounded-lg p-6 text-center hover:border-primary/50 transition-colors">
            <svg class="w-12 h-12 text-base-content/30 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
            </svg>
            <div class="mb-4">
              <label for="file-upload" class="btn btn-primary btn-sm cursor-pointer">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                </svg>
                Choose Files
              </label>
              <input id="file-upload" type="file" multiple class="hidden" accept=".pdf,.docx,.txt,.md,.csv,.json">
              <p class="text-sm text-base-content/60 mt-2">Upload PDFs, documents, or text files for RAG</p>
            </div>
          </div>
          
          <!-- File List -->
          <div id="file-list" class="space-y-2">
            <!-- Files will be populated here -->
          </div>
        </div>

        <!-- Website Scraping Section -->
        <div class="space-y-4">
          <h3 class="text-md font-medium text-base-content">Website Scraping</h3>
          <div class="space-y-3">
            <div class="flex gap-2">
              <input id="website-url" type="url" placeholder="Enter website URL" class="input input-bordered flex-1 bg-base-200/50">
              <button id="add-website" class="btn btn-secondary btn-sm">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                </svg>
                Add
              </button>
            </div>
            <p class="text-xs text-base-content/60">Add websites to scrape and include in your assistant's knowledge base</p>
          </div>
          
          <!-- Website List -->
          <div id="website-list" class="space-y-2">
            <!-- Websites will be populated here -->
          </div>
        </div>

        <!-- Knowledge Base Status -->
        <div class="bg-base-200/50 rounded-lg p-4">
          <div class="flex items-center justify-between mb-2">
            <h4 class="text-sm font-medium text-base-content">Knowledge Base Status</h4>
            <span class="badge badge-success badge-sm">Active</span>
          </div>
          <div class="grid grid-cols-2 gap-4 text-sm">
            <div>
              <span class="text-base-content/60">Files:</span>
              <span class="font-medium ml-2" id="file-count">0</span>
            </div>
            <div>
              <span class="text-base-content/60">Websites:</span>
              <span class="font-medium ml-2" id="website-count">0</span>
            </div>
          </div>
        </div>

      </div>
    </div>
  </section>
  {% endif %}

  <!-- VOICE Section Divider -->
  <div id="voice-section" class="flex items-center space-x-3 text-sm text-base-content/60 uppercase tracking-wider font-semibold">
    <svg class="w-5 h-5 text-cyan-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path>
    </svg>
    <span class="text-base-content/80">VOICE & PERSONA</span>
  </div>

  <!-- Voice Configuration subsection -->
  <section class="rounded-lg border border-base-content/10 bg-base-100 overflow-hidden">
    <!-- Header button -->
    <button
      type="button"
      aria-controls="collapsible-voice-config-tab-content"
      aria-expanded="false"
      data-state="closed"
      class="group flex w-full flex-row items-center justify-between bg-base-200/40 p-4"
    >
      <div class="flex flex-row items-start gap-3">
        <!-- Section icon -->
        <svg class="w-4 h-4 text-primary mt-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path>
        </svg>

        <!-- Title + helper -->
        <div class="flex flex-col items-start">
          <div class="flex flex-row items-center">
            <h2 class="text-lg font-medium text-base-content" data-testid="voice-config-header">Voice Configuration</h2>
            <!-- Hover-only helper icon (appears on hover like Vapi) -->
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 256 256"
                 class="ml-2 cursor-pointer text-base-content/50 opacity-0 transition-opacity group-hover:opacity-100">
              <path fill="currentColor"
                d="M240,88.23a54.43,54.43,0,0,1-16,37L189.25,160a54.27,54.27,0,0,1-38.63,16h-.05A54.63,54.63,0,0,1,96,119.84a8,8,0,0,1,16,.45A38.62,38.62,0,0,0,150.58,160h0a38.39,38.39,0,0,0,27.31-11.31l34.75-34.75a38.63,38.63,0,0,0-54.63-54.63l-11,11A8,8,0,0,1,135.7,59l11-11A54.65,54.65,0,0,1,224,48,54.86,54.86,0,0,1,240,88.23ZM109,185.66l-11,11A38.41,38.41,0,0,1,70.6,208h0a38.63,38.63,0,0,1-27.29-65.94L78,107.31A38.63,38.63,0,0,1,144,135.71a8,8,0,0,0,16,.45A54.86,54.86,0,0,0,144,96a54.65,54.65,0,0,0-77.27,0L32,130.75A54.62,54.62,0,0,0,70.56,224h0a54.28,54.28,0,0,0,38.64-16l11-11A8,8,0,0,0,109,185.66Z"/>
            </svg>
          </div>
          <p class="text-xs text-base-content/60 text-left">Select a voice from the list, or sync your voice library if it's missing. If errors persist, enable custom voice and add a voice ID.</p>
        </div>
      </div>

      <!-- Right chevron: rotates when expanded -->
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" aria-hidden="true"
           class="h-6 w-6 transform transition-transform duration-200 group-aria-expanded:rotate-180">
        <path fill="currentColor"
          d="M213.66,101.66l-80,80a8,8,0,0,1-11.32,0l-80-80A8,8,0,0,1,53.66,90.34L128,164.69l74.34-74.35a8,8,0,0,1,11.32,11.32Z"/>
      </svg>
    </button>

    <!-- Collapsible content -->
    <div id="collapsible-voice-config-tab-content" class="overflow-hidden transition-all duration-300 ease-in-out max-h-0" data-collapsed="true">
      <div class="p-4 space-y-3">
        <!-- Voice Configuration Form Fields -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
          
          <!-- Provider Selection -->
          <div class="space-y-2">
            <label for="voice-provider" class="block text-sm font-medium text-base-content">
              Provider
              <svg class="inline w-4 h-4 ml-1 text-base-content/50 cursor-help hover:text-primary transition-colors duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <circle cx="12" cy="12" r="10"></circle>
                <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                <line x1="12" y1="17" x2="12.01" y2="17"></line>
              </svg>
              <div class="tooltip tooltip-primary absolute z-10 opacity-0 pointer-events-none transition-opacity duration-200 bg-base-300 text-base-content text-xs rounded-lg px-3 py-2 max-w-xs">
                Select the voice provider service for generating speech
              </div>
            </label>
            <div class="relative">
              <select id="voice-provider" class="select select-bordered w-full bg-base-100">
                <option value="openai" {% if assistant_config.voice.voice.provider == 'openai' or not assistant_config.voice.voice %}selected{% endif %}> OpenAI</option>
                <option value="elevenlabs" {% if assistant_config.voice.voice.provider == 'elevenlabs' %}selected{% endif %}> ElevenLabs</option>
              </select>
            </div>
          </div>

          <!-- Voice Selection -->
          <div class="space-y-2">
            <label for="voice-selection" class="block text-sm font-medium text-base-content">
              Voice
              <svg class="inline w-4 h-4 ml-1 text-base-content/50 cursor-help hover:text-primary transition-colors duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <circle cx="12" cy="12" r="10"></circle>
                <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                <line x1="12" y1="17" x2="12.01" y2="17"></line>
              </svg>
              <div class="tooltip tooltip-primary absolute z-10 opacity-0 pointer-events-none transition-opacity duration-200 bg-base-300 text-base-content text-xs rounded-lg px-3 py-2 max-w-xs">
                Choose the specific voice model for speech synthesis
              </div>
            </label>
            <div class="relative">
              <select id="voice-selection" class="select select-bordered w-full bg-base-100" data-current-voice="{% if assistant_config.voice.voice %}{{ assistant_config.voice.voice.voice_id }}{% endif %}">
                <!-- Options will be populated dynamically by JavaScript -->
              </select>
            </div>
          </div>

        </div>
      </div>
    </div>
  </section>

  <!-- Additional Configuration subsection -->
  <section class="rounded-lg border border-base-content/10 bg-base-100 overflow-hidden">
    <!-- Header button -->
    <button
      type="button"
      aria-controls="collapsible-voice-additional-tab-content"
      aria-expanded="false"
      data-state="closed"
      class="group flex w-full flex-row items-center justify-between bg-base-200/40 p-4"
    >
      <div class="flex flex-row items-start gap-3">
        <!-- Section icon -->
        <svg class="w-4 h-4 text-primary mt-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path>
        </svg>

        <!-- Title + helper -->
        <div class="flex flex-col items-start">
          <div class="flex flex-row items-center">
            <h2 class="text-lg font-medium text-base-content" data-testid="voice-additional-header">Additional Configuration</h2>
            <!-- Hover-only helper icon (appears on hover like Vapi) -->
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 256 256"
                 class="ml-2 cursor-pointer text-base-content/50 opacity-0 transition-opacity group-hover:opacity-100">
              <path fill="currentColor"
                d="M240,88.23a54.43,54.43,0,0,1-16,37L189.25,160a54.27,54.27,0,0,1-38.63,16h-.05A54.63,54.63,0,0,1,96,119.84a8,8,0,0,1,16,.45A38.62,38.62,0,0,0,150.58,160h0a38.39,38.39,0,0,0,27.31-11.31l34.75-34.75a38.63,38.63,0,0,0-54.63-54.63l-11,11A8,8,0,0,1,135.7,59l11-11A54.65,54.65,0,0,1,224,48,54.86,54.86,0,0,1,240,88.23ZM109,185.66l-11,11A38.41,38.41,0,0,1,70.6,208h0a38.63,38.63,0,0,1-27.29-65.94L78,107.31A38.63,38.63,0,0,1,144,135.71a8,8,0,0,0,16,.45A54.86,54.86,0,0,0,144,96a54.65,54.65,0,0,0-77.27,0L32,130.75A54.62,54.62,0,0,0,70.56,224h0a54.28,54.28,0,0,0,38.64-16l11-11A8,8,0,0,0,109,185.66Z"/>
            </svg>
          </div>
          <p class="text-xs text-base-content/60 text-left">Configure additional settings for the voice of your assistant.</p>
        </div>
      </div>

      <!-- Right chevron: rotates when expanded -->
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" aria-hidden="true"
           class="h-6 w-6 transform transition-transform duration-200 group-aria-expanded:rotate-180">
        <path fill="currentColor"
          d="M213.66,101.66l-80,80a8,8,0,0,1-11.32,0l-80-80A8,8,0,0,1,53.66,90.34L128,164.69l74.34-74.35a8,8,0,0,1,11.32,11.32Z"/>
      </svg>
    </button>

    <!-- Collapsible content -->
    <div id="collapsible-voice-additional-tab-content" class="overflow-hidden transition-all duration-300 ease-in-out max-h-0" data-collapsed="true">
      <div class="p-4 space-y-3">
        <!-- Additional Configuration Form Fields -->
        
        <!-- Ambient Sound Configuration -->
        <div class="space-y-4">
          <h3 class="text-base font-medium text-base-content">Ambient Sound</h3>
          
          <!-- Enable Ambient Sound -->
          <div class="flex items-start space-x-3 p-3 bg-base-200/30 rounded-lg border border-base-content/10">
            <div class="flex items-center justify-center w-8 h-8 bg-base-300 rounded-lg">
              <svg class="w-4 h-4 text-base-content/70" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M6.343 6.343a8 8 0 000 11.314m2.829-9.9a5 5 0 000 7.07"></path>
              </svg>
            </div>
            <div class="flex-1">
              <div class="flex items-center justify-between mb-2">
                <div>
                  <h4 class="text-sm font-medium text-base-content">Enable Ambient Sound</h4>
                  <p class="text-xs text-base-content/60">Play ambient background sound during conversations</p>
                </div>
                <input type="checkbox" id="ambient-sound-enabled" class="toggle toggle-primary" {% if assistant_config.voice.ambient_sound_enabled %}checked{% endif %}>
              </div>
              
              <!-- Ambient Sound Settings (shown when enabled) -->
              <div id="ambient-sound-settings" class="space-y-3 mt-3" style="display: {% if assistant_config.voice.ambient_sound_enabled %}block{% else %}none{% endif %};">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-3">
                  <!-- Sound Type -->
                  <div>
                    <label class="text-xs font-medium text-base-content/80">Sound Type</label>
                    <select id="ambient-sound-type" class="select select-sm select-bordered w-full bg-base-100">
                      <option value="none" {% if assistant_config.voice.ambient_sound_type == 'none' %}selected{% endif %}>None</option>
                      <option value="office_ambience" {% if assistant_config.voice.ambient_sound_type == 'office_ambience' or not assistant_config.voice.ambient_sound_type %}selected{% endif %}>Office Ambience</option>
                      <option value="custom" {% if assistant_config.voice.ambient_sound_type == 'custom' %}selected{% endif %}>Custom URL</option>
                    </select>
                  </div>
                  
                  <!-- Volume -->
                  <div>
                    <label class="text-xs font-medium text-base-content/80">Volume (0-100)</label>
                    <input type="number" id="ambient-sound-volume" class="input input-sm input-bordered w-full bg-base-100" 
                           value="{% if assistant_config.voice.ambient_sound_volume %}{{ assistant_config.voice.ambient_sound_volume }}{% else %}10.0{% endif %}" 
                           min="0" max="100" step="0.1">
                  </div>
                </div>
                
                <!-- Custom URL (shown when custom is selected) -->
                <div id="ambient-sound-url-container" style="display: {% if assistant_config.voice.ambient_sound_type == 'custom' %}block{% else %}none{% endif %};">
                  <label class="text-xs font-medium text-base-content/80">Custom URL</label>
                  <input type="url" id="ambient-sound-url" class="input input-sm input-bordered w-full bg-base-100" 
                         value="{% if assistant_config.voice.ambient_sound_url %}{{ assistant_config.voice.ambient_sound_url }}{% endif %}"
                         placeholder="https://example.com/ambient-sound.mp3">
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Thinking Sound Configuration -->
        <div class="space-y-4">
          <h3 class="text-base font-medium text-base-content">Thinking Sound</h3>
          
          <!-- Enable Thinking Sound -->
          <div class="flex items-start space-x-3 p-3 bg-base-200/30 rounded-lg border border-base-content/10">
            <div class="flex items-center justify-center w-8 h-8 bg-base-300 rounded-lg">
              <svg class="w-4 h-4 text-base-content/70" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"></path>
              </svg>
            </div>
            <div class="flex-1">
              <div class="flex items-center justify-between mb-2">
                <div>
                  <h4 class="text-sm font-medium text-base-content">Enable Thinking Sound</h4>
                  <p class="text-xs text-base-content/60">Play keyboard typing sound when the agent is thinking</p>
                </div>
                <input type="checkbox" id="thinking-sound-enabled" class="toggle toggle-primary" {% if assistant_config.voice.thinking_sound_enabled %}checked{% endif %}>
              </div>
              
              <!-- Thinking Sound Settings (shown when enabled) -->
              <div id="thinking-sound-settings" class="space-y-3 mt-3" style="display: {% if assistant_config.voice.thinking_sound_enabled %}block{% else %}none{% endif %};">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-3">
                  <!-- Primary Sound -->
                  <div>
                    <label class="text-xs font-medium text-base-content/80">Primary Sound</label>
                    <select id="thinking-sound-primary" class="select select-sm select-bordered w-full bg-base-100">
                      <option value="none" {% if assistant_config.voice.thinking_sound_primary == 'none' %}selected{% endif %}>None</option>
                      <option value="keyboard_typing" {% if assistant_config.voice.thinking_sound_primary == 'keyboard_typing' or not assistant_config.voice.thinking_sound_primary %}selected{% endif %}>Keyboard Typing</option>
                      <option value="keyboard_typing2" {% if assistant_config.voice.thinking_sound_primary == 'keyboard_typing2' %}selected{% endif %}>Keyboard Typing 2</option>
                    </select>
                  </div>
                  
                  <!-- Primary Volume -->
                  <div>
                    <label class="text-xs font-medium text-base-content/80">Primary Volume (0-1)</label>
                    <input type="number" id="thinking-sound-primary-volume" class="input input-sm input-bordered w-full bg-base-100" 
                           value="{% if assistant_config.voice.thinking_sound_primary_volume %}{{ assistant_config.voice.thinking_sound_primary_volume }}{% else %}0.8{% endif %}" 
                           min="0" max="1" step="0.1">
                  </div>
                  
                  <!-- Secondary Sound -->
                  <div>
                    <label class="text-xs font-medium text-base-content/80">Secondary Sound</label>
                    <select id="thinking-sound-secondary" class="select select-sm select-bordered w-full bg-base-100">
                      <option value="none" {% if assistant_config.voice.thinking_sound_secondary == 'none' %}selected{% endif %}>None</option>
                      <option value="keyboard_typing" {% if assistant_config.voice.thinking_sound_secondary == 'keyboard_typing' %}selected{% endif %}>Keyboard Typing</option>
                      <option value="keyboard_typing2" {% if assistant_config.voice.thinking_sound_secondary == 'keyboard_typing2' or not assistant_config.voice.thinking_sound_secondary %}selected{% endif %}>Keyboard Typing 2</option>
                    </select>
                  </div>
                  
                  <!-- Secondary Volume -->
                  <div>
                    <label class="text-xs font-medium text-base-content/80">Secondary Volume (0-1)</label>
                    <input type="number" id="thinking-sound-secondary-volume" class="input input-sm input-bordered w-full bg-base-100" 
                           value="{% if assistant_config.voice.thinking_sound_secondary_volume %}{{ assistant_config.voice.thinking_sound_secondary_volume }}{% else %}0.7{% endif %}" 
                           min="0" max="1" step="0.1">
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </section>

  {% comment %}
  <!-- TRANSCRIBER Section Divider -->
  <div id="transcriber-section" class="flex items-center space-x-3 text-sm text-base-content/60 uppercase tracking-wider font-semibold">
    <svg class="w-5 h-5 text-cyan-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path>
    </svg>
    <span class="text-base-content/80">SPEECH-TO-TEXT</span>
  </div>

  <!-- TRANSCRIBER (Vapi-style collapsible) -->
  <section class="rounded-lg border border-base-content/10 bg-base-100 overflow-hidden">
    <!-- Header button -->
    <button
      type="button"
      aria-controls="collapsible-transcriber-tab-content"
      aria-expanded="false"
      data-state="closed"
      class="group flex w-full flex-row items-center justify-between bg-base-200/40 p-4"
    >
      <div class="flex flex-row items-start gap-3">
        <!-- Section icon -->
        <svg class="w-4 h-4 text-primary mt-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
        </svg>

        <!-- Title + helper -->
        <div class="flex flex-col items-start">
          <div class="flex flex-row items-center">
            <h2 class="text-lg font-medium text-base-content" data-testid="transcriber-header">Transcriber</h2>
            <!-- Hover-only helper icon (appears on hover like Vapi) -->
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 256 256"
                 class="ml-2 cursor-pointer text-base-content/50 opacity-0 transition-opacity group-hover:opacity-100">
              <path fill="currentColor"
                d="M240,88.23a54.43,54.43,0,0,1-16,37L189.25,160a54.27,54.27,0,0,1-38.63,16h-.05A54.63,54.63,0,0,1,96,119.84a8,8,0,0,1,16,.45A38.62,38.62,0,0,0,150.58,160h0a38.39,38.39,0,0,0,27.31-11.31l34.75-34.75a38.63,38.63,0,0,0-54.63-54.63l-11,11A8,8,0,0,1,135.7,59l11-11A54.65,54.65,0,0,1,224,48,54.86,54.86,0,0,1,240,88.23ZM109,185.66l-11,11A38.41,38.41,0,0,1,70.6,208h0a38.63,38.63,0,0,1-27.29-65.94L78,107.31A38.63,38.63,0,0,1,144,135.71a8,8,0,0,0,16,.45A54.86,54.86,0,0,0,144,96a54.65,54.65,0,0,0-77.27,0L32,130.75A54.62,54.62,0,0,0,70.56,224h0a54.28,54.28,0,0,0,38.64-16l11-11A8,8,0,0,0,109,185.66Z"/>
            </svg>
          </div>
          <p class="text-xs text-base-content/60 text-left">This section allows you to configure the transcription settings for the assistant.</p>
        </div>
      </div>

      <!-- Right chevron: rotates when expanded -->
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" aria-hidden="true"
           class="h-6 w-6 transform transition-transform duration-200 group-aria-expanded:rotate-180">
        <path fill="currentColor"
          d="M213.66,101.66l-80,80a8,8,0,0,1-11.32,0l-80-80A8,8,0,0,1,53.66,90.34L128,164.69l74.34-74.35a8,8,0,0,1,11.32,11.32Z"/>
      </svg>
    </button>

    <!-- Collapsible content -->
    <div id="collapsible-transcriber-tab-content" class="overflow-hidden transition-all duration-300 ease-in-out max-h-0" data-collapsed="true">
      <div class="p-4 space-y-3">
        
        <!-- Provider and Language Row -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
          
          <!-- Provider -->
          <div class="space-y-2">
            <label for="transcriber-provider" class="block text-sm font-medium text-base-content">
              Provider
              <svg class="inline w-4 h-4 ml-1 text-base-content/50 cursor-help hover:text-primary transition-colors duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <circle cx="12" cy="12" r="10"></circle>
                <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                <line x1="12" y1="17" x2="12.01" y2="17"></line>
              </svg>
              <div class="tooltip tooltip-primary absolute z-10 opacity-0 pointer-events-none transition-opacity duration-200 bg-base-300 text-base-content text-xs rounded-lg px-3 py-2 max-w-xs">
                Select the transcription service provider
              </div>
            </label>
            <div class="relative">
              <select id="transcriber-provider" class="select select-bordered w-full bg-base-100">
                <option value="deepgram" selected>🔵 Deepgram</option>
                <option value="openai"> OpenAI Whisper</option>
                <option value="assemblyai">🎯 AssemblyAI</option>
                <option value="azure">☁️ Azure Speech</option>
                <option value="google">🔍 Google Speech</option>
              </select>
            </div>
          </div>

          <!-- Language -->
          <div class="space-y-2">
            <label for="transcriber-language" class="block text-sm font-medium text-base-content">
              Language
              <svg class="inline w-4 h-4 ml-1 text-base-content/50 cursor-help hover:text-primary transition-colors duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <circle cx="12" cy="12" r="10"></circle>
                <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                <line x1="12" y1="17" x2="12.01" y2="17"></line>
              </svg>
              <div class="tooltip tooltip-primary absolute z-10 opacity-0 pointer-events-none transition-opacity duration-200 bg-base-300 text-base-content text-xs rounded-lg px-3 py-2 max-w-xs">
                Primary language for transcription
              </div>
            </label>
            <div class="relative">
              <select id="transcriber-language" class="select select-bordered w-full bg-base-100">
                <option value="en" selected>En</option>
                <option value="es">Es</option>
                <option value="fr">Fr</option>
                <option value="de">De</option>
                <option value="it">It</option>
                <option value="pt">Pt</option>
                <option value="multi">Multi</option>
              </select>
            </div>
            <div class="text-xs text-blue-400 mt-1">
              Pro tip: If you want to support both English and Spanish, you can set the language to <span class="font-medium">multi</span> and use <span class="font-medium">ElevenLabs Turbo 2.5</span> in the Voice tab.
            </div>
          </div>

        </div>

        <!-- Model -->
        <div class="space-y-2">
          <label for="transcriber-model" class="block text-sm font-medium text-base-content">
            Model
            <svg class="inline w-4 h-4 ml-1 text-base-content/50 cursor-help hover:text-primary transition-colors duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <circle cx="12" cy="12" r="10"></circle>
              <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
              <line x1="12" y1="17" x2="12.01" y2="17"></line>
            </svg>
            <div class="tooltip tooltip-primary absolute z-10 opacity-0 pointer-events-none transition-opacity duration-200 bg-base-300 text-base-content text-xs rounded-lg px-3 py-2 max-w-xs">
              Transcription model version to use
            </div>
          </label>
          <select id="transcriber-model" class="select select-bordered w-full bg-base-100">
            <option value="nova-3" selected>Nova 3</option>
            <option value="nova-2">Nova 2</option>
            <option value="nova-1">Nova 1</option>
            <option value="base">Base</option>
            <option value="enhanced">Enhanced</option>
          </select>
        </div>

        <!-- Background Denoising Enabled -->
        <div class="flex items-start space-x-3 p-3 bg-base-200/30 rounded-lg border border-base-content/10">
          <div class="flex items-center justify-center w-8 h-8 bg-base-300 rounded-lg">
            <svg class="w-4 h-4 text-base-content/70" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M6.343 6.343a8 8 0 000 11.314m2.829-9.9a5 5 0 000 7.07"></path>
            </svg>
          </div>
          <div class="flex-1">
            <div class="flex items-center justify-between">
              <div>
                <h3 class="text-sm font-medium text-base-content">Background Denoising Enabled</h3>
                <p class="text-xs text-base-content/60 text-left">Filter background noise while the user is talking.</p>
              </div>
              <input type="checkbox" id="background-denoising" class="toggle toggle-primary" checked>
            </div>
          </div>
        </div>

        <!-- Confidence Threshold -->
        <div class="flex items-start space-x-3 p-3 bg-base-200/30 rounded-lg border border-base-content/10">
          <div class="flex items-center justify-center w-8 h-8 bg-base-300 rounded-lg">
            <svg class="w-4 h-4 text-base-content/70" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
            </svg>
          </div>
          <div class="flex-1">
            <div class="flex items-center justify-between mb-2">
              <div>
                <h3 class="text-sm font-medium text-base-content">Confidence Threshold</h3>
                <p class="text-xs text-base-content/60 text-left">Transcripts with a confidence score below this threshold will be filtered out.</p>
              </div>
              <span class="text-sm font-medium text-base-content">0.4</span>
            </div>
            <div class="relative">
              <input type="range" id="confidence-threshold" min="0" max="1" step="0.01" value="0.4" class="range range-primary w-full">
              <div class="flex justify-between text-xs text-base-content/60 mt-1">
                <span>0</span>
                <span class="text-right">1.0</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Use Numerals -->
        <div class="flex items-start space-x-3 p-3 bg-base-200/30 rounded-lg border border-base-content/10">
          <div class="flex items-center justify-center w-8 h-8 bg-base-300 rounded-lg">
            <svg class="w-4 h-4 text-base-content/70" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"></path>
            </svg>
          </div>
          <div class="flex-1">
            <div class="flex items-center justify-between">
              <div>
                <h3 class="text-sm font-medium text-base-content">Use Numerals</h3>
                <p class="text-xs text-base-content/60 text-left">Convert numbers from words to digits in transcription.</p>
              </div>
              <input type="checkbox" id="use-numerals" class="toggle toggle-primary" checked>
            </div>
          </div>
        </div>

        <!-- Keyterms -->
        <div class="flex items-start space-x-3 p-3 bg-base-200/30 rounded-lg border border-base-content/10">
          <div class="flex items-center justify-center w-8 h-8 bg-base-300 rounded-lg">
            <svg class="w-4 h-4 text-base-content/70" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"></path>
            </svg>
          </div>
          <div class="flex-1">
            <div class="space-y-2">
              <h3 class="text-sm font-medium text-base-content">Keyterms</h3>
              <textarea 
                id="keyterms"
                class="textarea textarea-bordered w-full bg-base-100 min-h-[120px] resize-none" 
                placeholder="Enter keywords separated by spaces..."
              ></textarea>
              <p class="text-xs text-base-content/60 text-left">Enter keywords separated by spaces. These will be used as key terms for transcription.</p>
            </div>
          </div>
        </div>

      </div>
    </div>
  </section>

  {% endcomment %}

  <!-- PRIVACY Section Divider -->
  <div id="privacy-section" class="flex items-center space-x-3 text-sm text-base-content/60 uppercase tracking-wider font-semibold">
    <svg class="w-5 h-5 text-cyan-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
    </svg>
    <span class="text-base-content/80">PRIVACY SETTINGS</span>
  </div>

  <!-- PRIVACY (Vapi-style collapsible) -->
  <section class="rounded-lg border border-base-content/10 bg-base-100 overflow-hidden">
    <!-- Header button -->
    <button
      type="button"
      aria-controls="collapsible-privacy-tab-content"
      aria-expanded="false"
      data-state="closed"
      class="group flex w-full flex-row items-center justify-between bg-base-200/40 p-4"
    >
      <div class="flex flex-row items-start gap-3">
        <!-- Section icon -->
        <svg class="w-4 h-4 text-primary mt-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
        </svg>

        <!-- Title + helper -->
        <div class="flex flex-col items-start">
          <div class="flex flex-row items-center">
            <h2 class="text-lg font-medium text-base-content" data-testid="privacy-header">Privacy</h2>
            <!-- Hover-only helper icon (appears on hover like Vapi) -->
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 256 256"
                 class="ml-2 cursor-pointer text-base-content/50 opacity-0 transition-opacity group-hover:opacity-100">
              <path fill="currentColor"
                d="M240,88.23a54.43,54.43,0,0,1-16,37L189.25,160a54.27,54.27,0,0,1-38.63,16h-.05A54.63,54.63,0,0,1,96,119.84a8,8,0,0,1,16,.45A38.62,38.62,0,0,0,150.58,160h0a38.39,38.39,0,0,0,27.31-11.31l34.75-34.75a38.63,38.63,0,0,0-54.63-54.63l-11,11A8,8,0,0,1,135.7,59l11-11A54.65,54.65,0,0,1,224,48,54.86,54.86,0,0,1,240,88.23ZM109,185.66l-11,11A38.41,38.41,0,0,1,70.6,208h0a38.63,38.63,0,0,1-27.29-65.94L78,107.31A38.63,38.63,0,0,1,144,135.71a8,8,0,0,0,16,.45A54.86,54.86,0,0,0,144,96a54.65,54.65,0,0,0-77.27,0L32,130.75A54.62,54.62,0,0,0,70.56,224h0a54.28,54.28,0,0,0,38.64-16l11-11A8,8,0,0,1,109,185.66Z"/>
            </svg>
          </div>
          <p class="text-xs text-base-content/60 text-left">Configure audio recording settings for the assistant.</p>
        </div>
      </div>

      <!-- Right chevron: rotates when expanded -->
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" aria-hidden="true"
           class="h-6 w-6 transform transition-transform duration-200 group-aria-expanded:rotate-180">
        <path fill="currentColor"
          d="M213.66,101.66l-80,80a8,8,0,0,1-11.32,0l-80-80A8,8,0,0,1,53.66,90.34L128,164.69l74.34-74.35a8,8,0,0,1,11.32,11.32Z"/>
      </svg>
    </button>

    <!-- Collapsible content -->
    <div id="collapsible-privacy-tab-content" class="overflow-hidden transition-all duration-300 ease-in-out max-h-0" data-collapsed="true">
      <div class="p-4 space-y-3">
        
        <!-- Audio Recording -->
        <div class="flex items-start space-x-3 p-3 bg-base-200/30 rounded-lg border border-base-content/10">
          <div class="flex items-center justify-center w-8 h-8 bg-base-300 rounded-lg">
            <svg class="w-4 h-4 text-base-content/70" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path>
            </svg>
          </div>
          <div class="flex-1">
            <div class="flex items-center justify-between">
              <div>
                <h3 class="text-sm font-medium text-base-content">Audio Recording</h3>
                <p class="text-xs text-base-content/60 text-left">Record the conversation with the assistant.</p>
              </div>
              <input type="checkbox" id="audio-recording" class="toggle toggle-primary" {% if assistant_config.privacy.audio_recording %}checked{% endif %}>
            </div>
          </div>
        </div>

      </div>
    </div>
  </section>

  <!-- TOOLS Section Divider -->
  <div id="tools-section" class="flex items-center space-x-3 text-sm text-base-content/60 uppercase tracking-wider font-semibold">
    <svg class="w-5 h-5 text-cyan-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
    </svg>
    <span class="text-base-content/80">CONNECTED TOOLS</span>
  </div>

  <!-- Tools subsection -->
  <section class="rounded-lg border border-base-content/10 bg-base-100 overflow-hidden">
    <!-- Header button -->
    <button
      type="button"
      aria-controls="collapsible-tools-main-tab-content"
      aria-expanded="false"
      data-state="closed"
      class="group flex w-full flex-row items-center justify-between bg-base-200/40 p-4"
    >
      <div class="flex flex-row items-start gap-3">
        <!-- Section icon -->
        <svg class="w-4 h-4 text-primary mt-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
        </svg>

        <!-- Title + helper -->
        <div class="flex flex-col items-start">
          <div class="flex flex-row items-center">
            <h2 class="text-lg font-medium text-base-content" data-testid="tools-main-header">Tools</h2>
            <!-- Hover-only helper icon (appears on hover like Vapi) -->
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 256 256"
                 class="ml-2 cursor-pointer text-base-content/50 opacity-0 transition-opacity group-hover:opacity-100">
              <path fill="currentColor"
                d="M240,88.23a54.43,54.43,0,0,1-16,37L189.25,160a54.27,54.27,0,0,1-38.63,16h-.05A54.63,54.63,0,0,1,96,119.84a8,8,0,0,1,16,.45A38.62,38.62,0,0,0,150.58,160h0a38.39,38.39,0,0,0,27.31-11.31l34.75-34.75a38.63,38.63,0,0,0-54.63-54.63l-11,11A8,8,0,0,1,135.7,59l11-11A54.65,54.65,0,0,1,224,48A54.86,54.86,0,0,1,240,88.23ZM109,185.66l-11,11A38.41,38.41,0,0,1,70.6,208h0a38.63,38.63,0,0,1-27.29-65.94L78,107.31A38.63,38.63,0,0,1,144,135.71a8,8,0,0,0,16,.45A54.86,54.86,0,0,0,144,96a54.65,54.65,0,0,0-77.27,0L32,130.75A54.62,54.62,0,0,0,70.56,224h0a54.28,54.28,0,0,0,38.64-16l11-11A8,8,0,0,0,109,185.66Z"/>
            </svg>
          </div>
          <p class="text-xs text-base-content/60 text-left">Tools enable voicebots to perform actions during calls. Add tools from the Tools Library to connect with Make.com or CHL workflows, or create custom tools with your backend.</p>
        </div>
      </div>

      <!-- Right chevron: rotates when expanded -->
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" aria-hidden="true"
           class="h-6 w-6 transform transition-transform duration-200 group-aria-expanded:rotate-180">
        <path fill="currentColor"
          d="M213.66,101.66l-80,80a8,8,0,0,1-11.32,0l-80-80A8,8,0,0,1,53.66,90.34L128,164.69l74.34-74.35a8,8,0,0,1,11.32,11.32Z"/>
      </svg>
    </button>

    <!-- Collapsible content -->
    <div id="collapsible-tools-main-tab-content" class="overflow-hidden transition-all duration-300 ease-in-out max-h-0" data-collapsed="true">
      <div class="p-4 space-y-3">
        <!-- Tools Content -->
        
        <!-- Email Integration -->
        <div class="flex items-start space-x-3 p-3 bg-base-200/30 rounded-lg border border-base-content/10">
          <div class="flex items-center justify-center w-8 h-8 bg-base-300 rounded-lg">
            <svg class="w-4 h-4 text-base-content/70" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
            </svg>
          </div>
          <div class="flex-1">
            <div class="flex items-center justify-between">
              <div>
                <h3 class="text-sm font-medium text-base-content">Email Integration</h3>
                <p class="text-xs text-base-content/60 text-left">Enable email sending capabilities for your assistant</p>
              </div>
              <input 
                type="checkbox" 
                class="toggle toggle-primary config-toggle" 
                data-config-section="predefined_functions"
                data-config-key="email_integration"
                {% if assistant_config.predefined_functions.email_integration %}checked{% endif %}
              >
            </div>
          </div>
        </div>

        <!-- SMS Integration -->
        <div class="flex items-start space-x-3 p-3 bg-base-200/30 rounded-lg border border-base-content/10">
          <div class="flex items-center justify-center w-8 h-8 bg-base-300 rounded-lg">
            <svg class="w-4 h-4 text-base-content/70" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
            </svg>
          </div>
          <div class="flex-1">
            <div class="flex items-center justify-between">
              <div>
                <h3 class="text-sm font-medium text-base-content">SMS Integration</h3>
                <p class="text-xs text-base-content/60 text-left">Enable SMS sending capabilities for your assistant</p>
              </div>
              <input 
                type="checkbox" 
                class="toggle toggle-primary config-toggle" 
                data-config-section="predefined_functions"
                data-config-key="sms_integration"
                {% if assistant_config.predefined_functions.sms_integration %}checked{% endif %}
              >
            </div>
          </div>
        </div>

      </div>
    </div>
  </section>

  <!-- Predefined Functions subsection -->
  <section class="rounded-lg border border-base-content/10 bg-base-100 overflow-hidden">
    <!-- Header button -->
    <button
      type="button"
      aria-controls="collapsible-tools-predefined-tab-content"
      aria-expanded="false"
      data-state="closed"
      class="group flex w-full flex-row items-center justify-between bg-base-200/40 p-4"
    >
      <div class="flex flex-row items-start gap-3">
        <!-- Section icon -->
        <svg class="w-4 h-4 text-primary mt-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
        </svg>

        <!-- Title + helper -->
        <div class="flex flex-col items-start">
          <div class="flex flex-row items-center">
            <h2 class="text-lg font-medium text-base-content" data-testid="tools-predefined-header">Predefined Functions</h2>
            <!-- Hover-only helper icon (appears on hover like Vapi) -->
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 256 256"
                 class="ml-2 cursor-pointer text-base-content/50 opacity-0 transition-opacity group-hover:opacity-100">
              <path fill="currentColor"
                d="M240,88.23a54.43,54.43,0,0,1-16,37L189.25,160a54.27,54.27,0,0,1-38.63,16h-.05A54.63,54.63,0,0,1,96,119.84a8,8,0,0,1,16,.45A38.62,38.62,0,0,0,150.58,160h0a38.39,38.39,0,0,0,27.31-11.31l34.75-34.75a38.63,38.63,0,0,0-54.63-54.63l-11,11A8,8,0,0,1,135.7,59l11-11A54.65,54.65,0,0,1,224,48,54.86,54.86,0,0,1,240,88.23ZM109,185.66l-11,11A38.41,38.41,0,0,1,70.6,208h0a38.63,38.63,0,0,1-27.29-65.94L78,107.31A38.63,38.63,0,0,1,144,135.71a8,8,0,0,0,16,.45A54.86,54.86,0,0,0,144,96a54.65,54.65,0,0,0-77.27,0L32,130.75A54.62,54.62,0,0,0,70.56,224h0a54.28,54.28,0,0,0,38.64-16l11-11A8,8,0,0,0,109,185.66Z"/>
            </svg>
          </div>
          <p class="text-xs text-base-content/60 text-left">We've pre-built functions for common use cases. You can enable them and configure them below.</p>
        </div>
      </div>

      <!-- Right chevron: rotates when expanded -->
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" aria-hidden="true"
           class="h-6 w-6 transform transition-transform duration-200 group-aria-expanded:rotate-180">
        <path fill="currentColor"
          d="M213.66,101.66l-80,80a8,8,0,0,1-11.32,0l-80-80A8,8,0,0,1,53.66,90.34L128,164.69l74.34-74.35a8,8,0,0,1,11.32,11.32Z"/>
      </svg>
    </button>

    <!-- Collapsible content -->
    <div id="collapsible-tools-predefined-tab-content" class="overflow-hidden transition-all duration-300 ease-in-out max-h-0" data-collapsed="true">
      <div class="p-4 space-y-3">
        <!-- Predefined Functions Content -->
        
        <!-- Enable End Call Function -->
        <div class="flex items-start space-x-3 p-3 bg-base-200/30 rounded-lg border border-base-content/10">
          <div class="flex items-center justify-center w-8 h-8 bg-base-300 rounded-lg">
            <svg class="w-4 h-4 text-base-content/70" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
            </svg>
          </div>
          <div class="flex-1">
            <div class="flex items-center justify-between">
              <div>
                <h3 class="text-sm font-medium text-base-content">Enable End Call Function</h3>
                <p class="text-xs text-base-content/60 text-left">This will allow the assistant to end the call from its side.</p>
              </div>
              <input 
                type="checkbox" 
                class="toggle toggle-primary config-toggle" 
                data-config-section="predefined_functions"
                data-config-key="enable_end_call"
                {% if assistant_config.predefined_functions.enable_end_call %}checked{% endif %}
              >
            </div>
          </div>
        </div>





      </div>
    </div>
  </section>

  <!-- Custom Functions subsection -->
  {% comment %} <section class="rounded-lg border border-base-content/10 bg-base-100 overflow-hidden">
    <!-- Header button -->
    <button
      type="button"
      aria-controls="collapsible-tools-custom-tab-content"
      aria-expanded="false"
      data-state="closed"
      class="group flex w-full flex-row items-center justify-between bg-base-200/40 p-4"
    >
      <div class="flex flex-row items-start gap-3">
        <!-- Section icon -->
        <svg class="w-4 h-4 text-primary mt-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
        </svg>

        <!-- Title + helper -->
        <div class="flex flex-col items-start">
          <div class="flex flex-row items-center">
            <h2 class="text-lg font-medium text-base-content" data-testid="tools-custom-header">Custom Functions</h2>
            <!-- Hover-only helper icon (appears on hover like Vapi) -->
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 256 256"
                 class="ml-2 cursor-pointer text-base-content/50 opacity-0 transition-opacity group-hover:opacity-100">
              <path fill="currentColor"
                d="M240,88.23a54.43,54.43,0,0,1-16,37L189.25,160a54.27,54.27,0,0,1-38.63,16h-.05A54.63,54.63,0,0,1,96,119.84a8,8,0,0,1,16,.45A38.62,38.62,0,0,0,150.58,160h0a38.39,38.39,0,0,0,27.31-11.31l34.75-34.75a38.63,38.63,0,0,0-54.63-54.63l-11,11A8,8,0,0,1,135.7,59l11-11A54.65,54.65,0,0,1,224,48,54.86,54.86,0,0,1,240,88.23ZM109,185.66l-11,11A38.41,38.41,0,0,1,70.6,208h0a38.63,38.63,0,0,1-27.29-65.94L78,107.31A38.63,38.63,0,0,1,144,135.71a8,8,0,0,0,16,.45A54.86,54.86,0,0,0,144,96a54.65,54.65,0,0,0-77.27,0L32,130.75A54.62,54.62,0,0,0,70.56,224h0a54.28,54.28,0,0,0,38.64-16l11-11A8,8,0,0,0,109,185.66Z"/>
            </svg>
          </div>
          <p class="text-xs text-base-content/60 text-left">Define your custom functions here to enhance your assistant's capabilities. You can use your own code or tools like Pipedream or Make for the setup.</p>
        </div>
      </div>

      <!-- Right chevron: rotates when expanded -->
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" aria-hidden="true"
           class="h-6 w-6 transform transition-transform duration-200 group-aria-expanded:rotate-180">
        <path fill="currentColor"
          d="M213.66,101.66l-80,80a8,8,0,0,1-11.32,0l-80-80A8,8,0,0,1,53.66,90.34L128,164.69l74.34-74.35a8,8,0,0,1,11.32,11.32Z"/>
      </svg>
    </button>

    <!-- Collapsible content -->
    <div id="collapsible-tools-custom-tab-content" class="overflow-hidden transition-all duration-300 ease-in-out max-h-0" data-collapsed="true">
      <div class="p-4 space-y-3">
        <!-- Custom Functions Content -->
        
        <!-- Information Notice -->
        <div class="p-3 bg-amber-500/10 border border-amber-500/30 rounded-lg">
          <div class="flex items-start space-x-2">
            <svg class="w-4 h-4 text-amber-500 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <div class="text-xs text-amber-600">
              <span class="font-medium">Note:</span> Functions are the same as tools, except they follow older syntax as per the OpenAI Spec. Check our <span class="underline cursor-pointer">functions guide</span> for more details
            </div>
          </div>
        </div>

        <!-- Create New Function Button -->
        <div class="flex justify-center">
          <button class="btn btn-outline btn-sm border-dashed border-2 border-base-content/30 text-base-content/50 hover:border-primary hover:text-primary transition-colors duration-200 w-full py-8">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
            </svg>
            Create a new function
            <svg class="w-4 h-4 ml-2 text-base-content/30" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <circle cx="12" cy="12" r="10"></circle>
              <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
              <line x1="12" y1="17" x2="12.01" y2="17"></line>
            </svg>
          </button>
        </div>

      </div>
    </div>
  </section> {% endcomment %}

  <!-- ANALYSIS Section Divider -->
  <div id="analysis-section" class="flex items-center space-x-3 text-sm text-base-content/60 uppercase tracking-wider font-semibold">
    <svg class="w-5 h-5 text-cyan-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
    </svg>
    <span class="text-base-content/80">ANALYTICS & INSIGHTS</span>
  </div>

  <!-- Summary subsection -->
  <section class="rounded-lg border border-base-content/10 bg-base-100 overflow-hidden">
    <!-- Header button -->
    <button
      type="button"
      aria-controls="collapsible-analysis-summary-tab-content"
      aria-expanded="false"
      data-state="closed"
      class="group flex w-full flex-row items-center justify-between bg-base-200/40 p-4"
    >
      <div class="flex flex-row items-start gap-3">
        <!-- Section icon -->
        <svg class="w-4 h-4 text-primary mt-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
        </svg>

        <!-- Title + helper -->
        <div class="flex flex-col items-start">
          <div class="flex flex-row items-center">
            <h2 class="text-lg font-medium text-base-content" data-testid="analysis-summary-header">Summary</h2>
            <!-- Hover-only helper icon (appears on hover like Vapi) -->
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 256 256"
                 class="ml-2 cursor-pointer text-base-content/50 opacity-0 transition-opacity group-hover:opacity-100">
              <path fill="currentColor"
                d="M240,88.23a54.43,54.43,0,0,1-16,37L189.25,160a54.27,54.27,0,0,1-38.63,16h-.05A54.63,54.63,0,0,1,96,119.84a8,8,0,0,1,16,.45A38.62,38.62,0,0,0,150.58,160h0a38.39,38.39,0,0,0,27.31-11.31l34.75-34.75a38.63,38.63,0,0,0-54.63-54.63l-11,11A8,8,0,0,1,135.7,59l11-11A54.65,54.65,0,0,1,224,48,54.86,54.86,0,0,1,240,88.23ZM109,185.66l-11,11A38.41,38.41,0,0,1,70.6,208h0a38.63,38.63,0,0,1-27.29-65.94L78,107.31A38.63,38.63,0,0,1,144,135.71a8,8,0,0,0,16,.45A54.86,54.86,0,0,0,144,96a54.65,54.65,0,0,0-77.27,0L32,130.75A54.62,54.62,0,0,0,70.56,224h0a54.28,54.28,0,0,0,38.64-16l11-11A8,8,0,0,0,109,185.66Z"/>
            </svg>
          </div>
          <p class="text-xs text-base-content/60 text-left">This is the prompt that's used to summarize the call. The output is stored in call.analysis.summary. You can also find the summary in the Call Logs Page.</p>
        </div>
      </div>

      <!-- Right chevron: rotates when expanded -->
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" aria-hidden="true"
           class="h-6 w-6 transform transition-transform duration-200 group-aria-expanded:rotate-180">
        <path fill="currentColor"
          d="M213.66,101.66l-80,80a8,8,0,0,1-11.32,0l-80-80A8,8,0,0,1,53.66,90.34L128,164.69l74.34-74.35a8,8,0,0,1,11.32,11.32Z"/>
      </svg>
    </button>

    <!-- Collapsible content -->
    <div id="collapsible-analysis-summary-tab-content" class="overflow-hidden transition-all duration-300 ease-in-out max-h-0" data-collapsed="true">
      <div class="p-4 space-y-3">
        <!-- Summary Content -->
        
        <!-- Description -->
        <p class="text-sm text-base-content/70">This is the prompt that's used to summarize the Call. The output is stored in call.analysis.summary. You can also find the summary in the Call Logs Page.</p>

        <!-- Prompt Section -->
        <div class="space-y-2">
          <h3 class="text-sm font-medium text-base-content">Prompt</h3>
          <textarea 
            id="summary-prompt"
            class="textarea textarea-bordered w-full bg-base-100 min-h-[120px] resize-none" 
            placeholder="Enter summary prompt..."
          >{% if assistant_config.analytics.summary_prompt %}{{ assistant_config.analytics.summary_prompt }}{% else %}You are an expert note-taker. You will be given a transcript of a call. Summarize the call in 2-3 sentences, if applicable.{% endif %}</textarea>
        </div>



      </div>
    </div>
  </section>

  <!-- Success Evaluation subsection -->
  <section class="rounded-lg border border-base-content/10 bg-base-100 overflow-hidden">
    <!-- Header button -->
    <button
      type="button"
      aria-controls="collapsible-analysis-success-tab-content"
      aria-expanded="false"
      data-state="closed"
      class="group flex w-full flex-row items-center justify-between bg-base-200/40 p-4"
    >
      <div class="flex flex-row items-start gap-3">
        <!-- Section icon -->
        <svg class="w-4 h-4 text-primary mt-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
        </svg>

        <!-- Title + helper -->
        <div class="flex flex-col items-start">
          <div class="flex flex-row items-center">
            <h2 class="text-lg font-medium text-base-content" data-testid="analysis-success-header">Success Evaluation</h2>
            <!-- Hover-only helper icon (appears on hover like Vapi) -->
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 256 256"
                 class="ml-2 cursor-pointer text-base-content/50 opacity-0 transition-opacity group-hover:opacity-100">
              <path fill="currentColor"
                d="M240,88.23a54.43,54.43,0,0,1-16,37L189.25,160a54.27,54.27,0,0,1-38.63,16h-.05A54.63,54.63,0,0,1,96,119.84a8,8,0,0,1,16,.45A38.62,38.62,0,0,0,150.58,160h0a38.39,38.39,0,0,0,27.31-11.31l34.75-34.75a38.63,38.63,0,0,0-54.63-54.63l-11,11A8,8,0,0,1,135.7,59l11-11A54.65,54.65,0,0,1,224,48,54.86,54.86,0,0,1,240,88.23ZM109,185.66l-11,11A38.41,38.41,0,0,1,70.6,208h0a38.63,38.63,0,0,1-27.29-65.94L78,107.31A38.63,38.63,0,0,1,144,135.71a8,8,0,0,0,16,.45A54.86,54.86,0,0,0,144,96a54.65,54.65,0,0,0-77.27,0L32,130.75A54.62,54.62,0,0,0,70.56,224h0a54.28,54.28,0,0,0,38.64-16l11-11A8,8,0,0,0,109,185.66Z"/>
            </svg>
          </div>
          <p class="text-xs text-base-content/60 text-left">Evaluate if your call was successful. You can use Rubric standalone or in combination with Success Evaluation Prompt. If both are provided, they are concatenated into appropriate instructions.</p>
        </div>
      </div>

      <!-- Right chevron: rotates when expanded -->
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" aria-hidden="true"
           class="h-6 w-6 transform transition-transform duration-200 group-aria-expanded:rotate-180">
        <path fill="currentColor"
          d="M213.66,101.66l-80,80a8,8,0,0,1-11.32,0l-80-80A8,8,0,0,1,53.66,90.34L128,164.69l74.34-74.35a8,8,0,0,1,11.32,11.32Z"/>
      </svg>
    </button>

    <!-- Collapsible content -->
    <div id="collapsible-analysis-success-tab-content" class="overflow-hidden transition-all duration-300 ease-in-out max-h-0" data-collapsed="true">
      <div class="p-4 space-y-3">
        <!-- Success Evaluation Content -->
        
        <!-- Prompt Section -->
        <div class="space-y-2">
          <label class="text-sm font-medium text-base-content">Prompt</label>
          <p class="text-xs text-amber-500">This is the prompt that's used to evaluate if the call was successful.</p>
          <textarea 
            id="success-prompt"
            class="textarea textarea-bordered w-full bg-base-100 min-h-[120px] resize-none" 
            placeholder="Enter success evaluation prompt..."
          >{% if assistant_config.analytics.success_prompt %}{{ assistant_config.analytics.success_prompt }}{% else %}You are an expert call evaluator. You will be given a transcript of a call and the system prompt of the AI participant. Determine if the call was successful based on the objectives inferred from the system prompt.{% endif %}</textarea>
        </div>



      </div>
    </div>
  </section>

  <!-- Structured Data subsection -->
  <section class="rounded-lg border border-base-content/10 bg-base-100 overflow-hidden">
    <!-- Header button -->
    <button
      type="button"
      aria-controls="collapsible-analysis-data-tab-content"
      aria-expanded="false"
      data-state="closed"
      class="group flex w-full flex-row items-center justify-between bg-base-200/40 p-4"
    >
      <div class="flex flex-row items-start gap-3">
        <!-- Section icon -->
        <svg class="w-4 h-4 text-primary mt-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
        </svg>

        <!-- Title + helper -->
        <div class="flex flex-col items-start">
          <div class="flex flex-row items-center">
            <h2 class="text-lg font-medium text-base-content" data-testid="analysis-data-header">Structured Data</h2>
            <!-- Hover-only helper icon (appears on hover like Vapi) -->
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 256 256"
                 class="ml-2 cursor-pointer text-base-content/50 opacity-0 transition-opacity group-hover:opacity-100">
              <path fill="currentColor"
                d="M240,88.23a54.43,54.43,0,0,1-16,37L189.25,160a54.27,54.27,0,0,1-38.63,16h-.05A54.63,54.63,0,0,1,96,119.84a8,8,0,0,1,16,.45A38.62,38.62,0,0,0,150.58,160h0a38.39,38.39,0,0,0,27.31-11.31l34.75-34.75a38.63,38.63,0,0,0-54.63-54.63l-11,11A8,8,0,0,1,135.7,59l11-11A54.65,54.65,0,0,1,224,48,54.86,54.86,0,0,1,240,88.23ZM109,185.66l-11,11A38.41,38.41,0,0,1,70.6,208h0a38.63,38.63,0,0,1-27.29-65.94L78,107.31A38.63,38.63,0,0,1,144,135.71a8,8,0,0,0,16,.45A54.86,54.86,0,0,0,144,96a54.65,54.65,0,0,0-77.27,0L32,130.75A54.62,54.62,0,0,0,70.56,224h0a54.28,54.28,0,0,0,38.64-16l11-11A8,8,0,0,0,109,185.66Z"/>
            </svg>
          </div>
          <p class="text-xs text-base-content/60 text-left">Extract structured data from call conversation. You can use Data Schema standalone or in combination with Structured Data Prompt. If both are provided, they are concatenated into appropriate instructions.</p>
        </div>
      </div>

      <!-- Right chevron: rotates when expanded -->
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" aria-hidden="true"
           class="h-6 w-6 transform transition-transform duration-200 group-aria-expanded:rotate-180">
        <path fill="currentColor"
          d="M213.66,101.66l-80,80a8,8,0,0,1-11.32,0l-80-80A8,8,0,0,1,53.66,90.34L128,164.69l74.34-74.35a8,8,0,0,1,11.32,11.32Z"/>
      </svg>
    </button>

    <!-- Collapsible content -->
    <div id="collapsible-analysis-data-tab-content" class="overflow-hidden transition-all duration-300 ease-in-out max-h-0" data-collapsed="true">
      <div class="p-4 space-y-3">
        <!-- Structured Data Content -->
        
        <!-- Prompt Section -->
        <div class="space-y-2">
          <label class="text-sm font-medium text-base-content">Prompt</label>
          <p class="text-xs text-amber-500">This is the prompt that's used to extract structured data from the call.</p>
          <textarea 
            id="structured-prompt"
            class="textarea textarea-bordered w-full bg-base-100 min-h-[120px] resize-none" 
            placeholder="Enter structured data prompt..."
          >{% if assistant_config.analytics.structured_prompt %}{{ assistant_config.analytics.structured_prompt }}{% else %}You will be given a transcript of a call and the system prompt of the AI participant. Extract structured data according to the schema below.{% endif %}</textarea>
        </div>



        <!-- Add Property Button -->
        <div class="pt-2">
          <button class="btn btn-outline btn-sm border-dashed border-2 border-base-content/30 text-base-content/50 hover:border-primary hover:text-primary transition-colors duration-200">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
            </svg>
            Add Property
          </button>
        </div>

      </div>
    </div>
  </section>

{% else %}
  <!-- Empty State - No Assistant Selected -->
  <div class="flex flex-col items-center justify-center h-96 text-center">
    <div class="w-24 h-24 bg-base-200 rounded-full flex items-center justify-center mb-6">
      <svg class="w-12 h-12 text-base-content/30" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
      </svg>
    </div>
    
    <h2 class="text-xl font-semibold text-base-content mb-2">No Assistant Selected</h2>
    <p class="text-base-content/60 mb-6 max-w-md">
      {% if assistant_count == 0 %}
        Create your first AI assistant to get started with voice conversations.
      {% else %}
        Select an assistant from the sidebar to view and configure its settings.
      {% endif %}
    </p>
    
    {% if assistant_count == 0 %}
    <button id="empty-state-create-btn" class="btn btn-primary">
      <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
      </svg>
      Create Your First Assistant
    </button>
    {% endif %}
  </div>
{% endif %}

</div>


<!-- Load component styles and page JavaScript -->
<link rel="stylesheet" href="{% static 'css/components.css' %}">
<script type="module" src="{% static 'js/assistants.js' %}" defer></script>

<script>
// Get CSRF token
function getCSRFToken() {
    const csrfInput = document.querySelector('[name=csrfmiddlewaretoken]');
    if (csrfInput) {
        return csrfInput.value;
    }
    // Fallback to meta tag or Django template variable
    const csrfMeta = document.querySelector('meta[name=csrf-token]');
    if (csrfMeta) {
        return csrfMeta.getAttribute('content');
    }
    return '{{ csrf_token }}';
}

// Save Assistant Configuration
async function saveAssistantConfig(btn) {
    const originalText = btn.innerHTML;
    
    // Show loading state
    btn.disabled = true;
    btn.innerHTML = '<span class="loading loading-spinner loading-sm mr-2"></span>Saving...';
    
    try {
        console.log('Saving assistant configuration...');
        
        // Get the selected assistant ID from URL
        const currentUrl = new URL(window.location);
        const selectedAssistantId = currentUrl.searchParams.get('selected') || '{{ selected_assistant.id }}';
        
        if (!selectedAssistantId || selectedAssistantId === 'None') {
            throw new Error('No assistant selected');
        }
        
        // Collect form data
        const configData = {
            model: {
                provider: document.getElementById('model-provider')?.value || '',
                model_name: document.getElementById('model-name')?.value || '',
                first_message_mode: document.getElementById('first-message-mode')?.value || '',
                first_message: document.getElementById('first-message')?.value || '',
                system_prompt: document.getElementById('system-prompt')?.value || '',

            },
            voice: {
                voice_id: document.getElementById('voice-selection')?.value || '',
                ambient_sound_enabled: document.getElementById('ambient-sound-enabled')?.checked || false,
                ambient_sound_type: document.getElementById('ambient-sound-type')?.value || '',
                ambient_sound_volume: document.getElementById('ambient-sound-volume')?.value || '',
                ambient_sound_url: document.getElementById('ambient-sound-url')?.value || '',
                thinking_sound_enabled: document.getElementById('thinking-sound-enabled')?.checked || false,
                thinking_sound_primary: document.getElementById('thinking-sound-primary')?.value || '',
                thinking_sound_primary_volume: document.getElementById('thinking-sound-primary-volume')?.value || '',
                thinking_sound_secondary: document.getElementById('thinking-sound-secondary')?.value || '',
                thinking_sound_secondary_volume: document.getElementById('thinking-sound-secondary-volume')?.value || ''
            },
            privacy: {
                audio_recording: document.getElementById('audio-recording')?.checked || false
            },
            advanced: {
                turn_detection_threshold: document.getElementById('turn-detection-threshold')?.value || '',
                turn_detection_silence_duration_ms: document.getElementById('turn-detection-silence-duration')?.value || '',
                turn_detection_prefix_padding_ms: document.getElementById('turn-detection-prefix-padding')?.value || '',
                turn_detection_create_response: document.getElementById('turn-detection-create-response')?.checked || false,
                turn_detection_interrupt_response: document.getElementById('turn-detection-interrupt-response')?.checked || false
            },
            predefined_functions: {
                enable_end_call: document.querySelector('input[data-config-key="enable_end_call"]')?.checked || false,
                email_integration: document.querySelector('input[data-config-key="email_integration"]')?.checked || false,
                sms_integration: document.querySelector('input[data-config-key="sms_integration"]')?.checked || false
            },
            analytics: {
                summary_prompt: document.getElementById('summary-prompt')?.value || '',
                success_prompt: document.getElementById('success-prompt')?.value || '',
                structured_prompt: document.getElementById('structured-prompt')?.value || ''
            }
        };
        
        console.log('Configuration data:', configData);
        
        const response = await fetch(`{% url "dashboard:save_assistant_config" "00000000-0000-0000-0000-000000000000" %}`.replace('00000000-0000-0000-0000-000000000000', selectedAssistantId), {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken(),
            },
            body: JSON.stringify(configData)
        });
        
        console.log('Response status:', response.status);
        const data = await response.json();
        console.log('Response data:', data);
        
        if (data.success) {
            // Show success message
            const alert = document.createElement('div');
            alert.className = 'alert alert-success fixed top-4 right-4 z-50 max-w-sm';
            alert.innerHTML = `
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
                <span>${data.message}</span>
            `;
            document.body.appendChild(alert);
            
            // Remove alert after 3 seconds
            setTimeout(() => {
                alert.remove();
            }, 3000);
        } else {
            throw new Error(data.error || 'Failed to save configuration');
        }
    } catch (error) {
        console.error('Error saving configuration:', error);
        
        // Show error message
        const alert = document.createElement('div');
        alert.className = 'alert alert-error fixed top-4 right-4 z-50 max-w-sm';
        alert.innerHTML = `
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
            <span>Error: ${error.message}</span>
        `;
        document.body.appendChild(alert);
        
        // Remove alert after 5 seconds
        setTimeout(() => {
            alert.remove();
        }, 5000);
    } finally {
        // Restore button state
        btn.disabled = false;
        btn.innerHTML = originalText;
    }
}

// Create Assistant functionality
async function createAssistant(btn) {
    const originalText = btn.innerHTML;
    
    // Show loading state
    btn.disabled = true;
    btn.innerHTML = '<span class="loading loading-spinner loading-sm mr-2"></span>Creating...';
    
    try {
        console.log('Creating assistant...');
        const response = await fetch('{% url "dashboard:create_assistant" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': getCSRFToken(),
            },
            body: 'name=Maha'
        });
        
        console.log('Response status:', response.status);
        const data = await response.json();
        console.log('Response data:', data);
        
        if (data.success) {
            // Show success message
            const alert = document.createElement('div');
            alert.className = 'alert alert-success fixed top-4 right-4 z-50 max-w-sm';
            alert.innerHTML = `
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
                <span>${data.message}</span>
            `;
            document.body.appendChild(alert);
            
            // Remove alert after 3 seconds
            setTimeout(() => {
                alert.remove();
            }, 3000);
            
            // Reload page to show new assistant
            setTimeout(() => {
                window.location.reload();
            }, 1500);
        } else {
            throw new Error(data.error || 'Failed to create assistant');
        }
    } catch (error) {
        console.error('Error creating assistant:', error);
        
        // Show error message
        const alert = document.createElement('div');
        alert.className = 'alert alert-error fixed top-4 right-4 z-50 max-w-sm';
        alert.innerHTML = `
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
            <span>Error: ${error.message}</span>
        `;
        document.body.appendChild(alert);
        
        // Remove alert after 5 seconds
        setTimeout(() => {
            alert.remove();
        }, 5000);
    } finally {
        // Restore button state
        btn.disabled = false;
        btn.innerHTML = originalText;
    }
}

// Load assistant details
function selectAssistant(assistantId) {
    console.log('Selecting assistant:', assistantId);
    // Navigate to the same page with selected assistant parameter
    const currentUrl = new URL(window.location);
    currentUrl.searchParams.set('selected', assistantId);
    window.location.href = currentUrl.toString();
}

// Voice data mapping
const VOICE_DATA = {
    openai: [
        { id: 'alloy', name: 'Alloy (OpenAI)' },
        { id: 'ash', name: 'Ash (OpenAI)' },
        { id: 'ballad', name: 'Ballad (OpenAI)' },
        { id: 'coral', name: 'Coral (OpenAI)' },
        { id: 'sage', name: 'Sage (OpenAI)' },
        { id: 'verse', name: 'Verse (OpenAI)' }
    ],
    elevenlabs: [
        { id: 'maha_voice_id', name: 'Maha (ElevenLabs)' },
        { id: 'sarah_voice_id', name: 'Sarah (ElevenLabs)' },
        { id: 'alex_voice_id', name: 'Alex (ElevenLabs)' },
        { id: 'jordan_voice_id', name: 'Jordan (ElevenLabs)' },
        { id: 'casey_voice_id', name: 'Casey (ElevenLabs)' },
        { id: 'riley_voice_id', name: 'Riley (ElevenLabs)' },
        { id: 'morgan_voice_id', name: 'Morgan (ElevenLabs)' },
        { id: 'elliot_voice_id', name: 'Elliot (ElevenLabs)' }
    ]
};

// Update voice selection based on provider
function updateVoiceSelection(provider, currentVoiceId = null) {
    const voiceSelect = document.getElementById('voice-selection');
    if (!voiceSelect) return;
    
    console.log('Updating voice selection for provider:', provider, 'current voice:', currentVoiceId);
    
    // Clear existing options
    voiceSelect.innerHTML = '';
    
    // Get voices for the selected provider
    const voices = VOICE_DATA[provider] || [];
    
    // Add new options
    voices.forEach(voice => {
        const option = document.createElement('option');
        option.value = voice.id;
        option.textContent = voice.name;
        
        // Set as selected if it matches current voice
        if (currentVoiceId && voice.id === currentVoiceId) {
            option.selected = true;
        }
        
        voiceSelect.appendChild(option);
    });
    
    // If no current voice is set, select the first option for OpenAI (Ash) or first for ElevenLabs
    if (!currentVoiceId && voices.length > 0) {
        if (provider === 'openai') {
            // Default to Ash for OpenAI
            const ashOption = voiceSelect.querySelector('option[value="ash"]');
            if (ashOption) {
                ashOption.selected = true;
            } else {
                voiceSelect.selectedIndex = 0;
            }
        } else {
            voiceSelect.selectedIndex = 0;
        }
    }
}

// Handle voice provider change
function handleVoiceProviderChange() {
    const providerSelect = document.getElementById('voice-provider');
    const voiceSelect = document.getElementById('voice-selection');
    
    if (!providerSelect || !voiceSelect) return;
    
    providerSelect.addEventListener('change', function() {
        const selectedProvider = this.value;
        console.log('Voice provider changed to:', selectedProvider);
        updateVoiceSelection(selectedProvider);
    });
}

// Handle config toggle auto-save functionality
function handleConfigToggleAutoSave() {
    // Add event listeners to all config-toggle elements
    const configToggles = document.querySelectorAll('.config-toggle');
    console.log('Found config toggles:', configToggles.length);
    
    configToggles.forEach(toggle => {
        toggle.addEventListener('change', function() {
            console.log('Config toggle changed:', this.dataset.configKey, 'to:', this.checked);
            
            // Auto-save the configuration with a small delay to avoid rapid firing
            clearTimeout(window.configSaveTimeout);
            window.configSaveTimeout = setTimeout(() => {
                // Create a temporary save button element for the save function
                const tempBtn = document.createElement('button');
                tempBtn.innerHTML = 'Auto-saving...';
                saveAssistantConfig(tempBtn);
            }, 500); // 500ms delay
        });
    });
}

// Handle audio configuration toggles
function handleAudioConfigurationToggles() {
    // Ambient sound toggle
    const ambientSoundToggle = document.getElementById('ambient-sound-enabled');
    const ambientSoundSettings = document.getElementById('ambient-sound-settings');
    
    if (ambientSoundToggle && ambientSoundSettings) {
        ambientSoundToggle.addEventListener('change', function() {
            ambientSoundSettings.style.display = this.checked ? 'block' : 'none';
            // Update accordion height after showing/hiding settings
            updateAccordionHeight('collapsible-voice-additional-tab-content');
        });
    }
    
    // Thinking sound toggle
    const thinkingSoundToggle = document.getElementById('thinking-sound-enabled');
    const thinkingSoundSettings = document.getElementById('thinking-sound-settings');
    
    if (thinkingSoundToggle && thinkingSoundSettings) {
        thinkingSoundToggle.addEventListener('change', function() {
            thinkingSoundSettings.style.display = this.checked ? 'block' : 'none';
            // Update accordion height after showing/hiding settings
            updateAccordionHeight('collapsible-voice-additional-tab-content');
        });
    }
    
    // Ambient sound type change (show/hide custom URL)
    const ambientSoundType = document.getElementById('ambient-sound-type');
    const ambientSoundUrlContainer = document.getElementById('ambient-sound-url-container');
    
    if (ambientSoundType && ambientSoundUrlContainer) {
        ambientSoundType.addEventListener('change', function() {
            ambientSoundUrlContainer.style.display = this.value === 'custom' ? 'block' : 'none';
            // Update accordion height after showing/hiding custom URL container
            updateAccordionHeight('collapsible-voice-additional-tab-content');
        });
    }
    
    // Add event listeners for any other dynamic content changes that might affect height
    const allAudioToggles = document.querySelectorAll('input[type="checkbox"], select');
    allAudioToggles.forEach(toggle => {
        if (toggle.closest('#collapsible-voice-additional-tab-content')) {
            toggle.addEventListener('change', function() {
                // Small delay to ensure DOM updates are complete
                setTimeout(() => {
                    updateAccordionHeight('collapsible-voice-additional-tab-content');
                }, 50);
            });
        }
    });
}

// Function to update accordion height when content changes
function updateAccordionHeight(accordionId) {
    const accordionContent = document.getElementById(accordionId);
    if (!accordionContent) return;
    
    // Only update height if the accordion is currently expanded
    if (accordionContent.dataset.collapsed === 'false') {
        // Use a small delay to ensure DOM updates are complete
        setTimeout(() => {
            // Force recalculation by temporarily removing maxHeight
            accordionContent.style.maxHeight = 'none';
            
            // Get the new scroll height
            const newHeight = accordionContent.scrollHeight;
            
            // Set the new max height with smooth transition
            accordionContent.style.maxHeight = newHeight + 'px';
            
            // Log for debugging
            console.log(`Updated accordion ${accordionId} height to:`, newHeight);
        }, 10);
    }
}

// Function to force update all expanded accordions (useful for dynamic content changes)
function updateAllExpandedAccordions() {
    const expandedSections = document.querySelectorAll('[data-collapsed="false"]');
    expandedSections.forEach(section => {
        // Temporarily remove maxHeight to force recalculation
        section.style.maxHeight = 'none';
        const newHeight = section.scrollHeight;
        section.style.maxHeight = newHeight + 'px';
    });
}

// Copy to clipboard function
function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(function() {
        // Show success feedback
        const alert = document.createElement('div');
        alert.className = 'alert alert-info fixed top-4 right-4 z-50 max-w-sm';
        alert.innerHTML = `
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
            </svg>
            <span>Copied to clipboard!</span>
        `;
        document.body.appendChild(alert);
        
        setTimeout(() => {
            alert.remove();
        }, 2000);
    });
}

// ============================================================================
// KNOWLEDGE BASE FUNCTIONALITY
// ============================================================================

function initializeKnowledgeBase() {
    console.log('Initializing knowledge base functionality...');
    
    // File upload handling
    const fileUpload = document.getElementById('file-upload');
    if (fileUpload) {
        fileUpload.addEventListener('change', handleFileUpload);
    }
    
    // Add website button
    const addWebsiteBtn = document.getElementById('add-website');
    if (addWebsiteBtn) {
        addWebsiteBtn.addEventListener('click', handleAddWebsite);
    }
    
    // Load initial knowledge base data
    const currentUrl = new URL(window.location);
    let selectedAssistantId = currentUrl.searchParams.get('selected');
    
    // Fallback to template variable if no URL parameter
    if (!selectedAssistantId) {
        const templateAssistantId = '{{ selected_assistant.id|default:"" }}';
        selectedAssistantId = templateAssistantId !== '' && templateAssistantId !== 'None' ? templateAssistantId : null;
    }
    
    if (selectedAssistantId && selectedAssistantId !== 'None') {
        loadKnowledgeBaseData(selectedAssistantId);
    }
}

function handleFileUpload(event) {
    const files = event.target.files;
    if (!files.length) return;
    
    // Get the selected assistant ID from URL
    const currentUrl = new URL(window.location);
    let selectedAssistantId = currentUrl.searchParams.get('selected');
    
    // Fallback to template variable if no URL parameter
    if (!selectedAssistantId) {
        const templateAssistantId = '{{ selected_assistant.id|default:"" }}';
        selectedAssistantId = templateAssistantId !== '' && templateAssistantId !== 'None' ? templateAssistantId : null;
    }
    
    // Validate that we have a valid UUID format
    const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i;
    if (!selectedAssistantId || selectedAssistantId === 'None' || !uuidRegex.test(selectedAssistantId)) {
        showAlert('Please select an assistant first', 'error');
        return;
    }
    
    const formData = new FormData();
    formData.append('file', files[0]);
    
    // Show loading state
    const fileList = document.getElementById('file-list');
    const loadingItem = createFileItem({
        id: 'loading',
        name: files[0].name,
        size: files[0].size,
        status: 'uploading'
    });
    fileList.appendChild(loadingItem);
    
    // Upload file
    fetch(`/assistants/${selectedAssistantId}/upload-file/`, {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Replace loading item with actual file
            loadingItem.remove();
            const fileItem = createFileItem(data);
            fileList.appendChild(fileItem);
            updateFileCount(fileList.children.length);
        } else {
            loadingItem.remove();
            updateKnowledgeBaseHeight();
            showAlert('Error uploading file: ' + data.error, 'error');
        }
    })
    .catch(error => {
        loadingItem.remove();
        updateKnowledgeBaseHeight();
        showAlert('Error uploading file: ' + error.message, 'error');
    });
    
    // Clear file input
    event.target.value = '';
}

function handleAddWebsite() {
    const urlInput = document.getElementById('website-url');
    const url = urlInput.value.trim();
    
    if (!url) {
        showAlert('Please enter a valid URL', 'error');
        return;
    }
    
    // Get the selected assistant ID from URL
    const currentUrl = new URL(window.location);
    let selectedAssistantId = currentUrl.searchParams.get('selected');
    
    // Fallback to template variable if no URL parameter
    if (!selectedAssistantId) {
        const templateAssistantId = '{{ selected_assistant.id|default:"" }}';
        selectedAssistantId = templateAssistantId !== '' && templateAssistantId !== 'None' ? templateAssistantId : null;
    }
    
    // Validate that we have a valid UUID format
    const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i;
    if (!selectedAssistantId || selectedAssistantId === 'None' || !uuidRegex.test(selectedAssistantId)) {
        showAlert('Please select an assistant first', 'error');
        return;
    }
    
    const formData = new FormData();
    formData.append('url', url);
    
    // Show loading state
    const websiteList = document.getElementById('website-list');
    const loadingItem = createWebsiteItem({
        id: 'loading',
        name: 'Loading...',
        url: url,
        status: 'adding'
    });
    websiteList.appendChild(loadingItem);
    
    // Add website
    fetch(`/assistants/${selectedAssistantId}/add-website/`, {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Replace loading item with actual website
            loadingItem.remove();
            const websiteItem = createWebsiteItem(data);
            websiteList.appendChild(websiteItem);
            updateWebsiteCount(websiteList.children.length);
            urlInput.value = '';
        } else {
            loadingItem.remove();
            updateKnowledgeBaseHeight();
            showAlert('Error adding website: ' + data.error, 'error');
        }
    })
    .catch(error => {
        loadingItem.remove();
        updateKnowledgeBaseHeight();
        showAlert('Error adding website: ' + error.message, 'error');
        urlInput.value = '';
    });
}

function createFileItem(file) {
    const item = document.createElement('div');
    item.className = 'flex items-center justify-between p-3 bg-base-200/50 rounded-lg';
    item.innerHTML = `
        <div class="flex items-center space-x-3">
            <svg class="w-5 h-5 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
            </svg>
            <div>
                <div class="font-medium text-sm">${file.name}</div>
                <div class="text-xs text-base-content/60">${formatFileSize(file.size)}</div>
            </div>
        </div>
        <div class="flex items-center space-x-2">
            <span class="badge badge-sm ${getStatusBadgeClass(file.status)}">${file.status}</span>
            <button onclick="deleteFile('${file.id}')" class="btn btn-ghost btn-xs text-error hover:bg-error/10">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                </svg>
            </button>
        </div>
    `;
    return item;
}

function createWebsiteItem(website) {
    const item = document.createElement('div');
    item.className = 'flex items-center justify-between p-3 bg-base-200/50 rounded-lg';
    item.innerHTML = `
        <div class="flex items-center space-x-3">
            <svg class="w-5 h-5 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9"></path>
            </svg>
            <div>
                <div class="font-medium text-sm">${website.name}</div>
                <div class="text-xs text-base-content/60">${website.url}</div>
            </div>
        </div>
        <div class="flex items-center space-x-2">
            <span class="badge badge-sm ${getStatusBadgeClass(website.status)}">${website.status}</span>
            <button onclick="deleteWebsite(${website.id})" class="btn btn-ghost btn-xs text-error hover:bg-error/10">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                </svg>
            </button>
        </div>
    `;
    return item;
}

function deleteFile(fileId) {
    if (!confirm('Are you sure you want to delete this file?')) return;
    
    // Get the selected assistant ID from URL
    const currentUrl = new URL(window.location);
    const selectedAssistantId = currentUrl.searchParams.get('selected') || '{{ selected_assistant.id }}';
    
    if (!selectedAssistantId || selectedAssistantId === 'None') {
        showAlert('No assistant selected', 'error');
        return;
    }
    
    fetch(`/assistants/${selectedAssistantId}/delete-file/${fileId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Remove file item from DOM
            const fileItem = document.querySelector(`[onclick="deleteFile('${fileId}')"]`).closest('.flex');
            fileItem.remove();
            const fileList = document.getElementById('file-list');
            updateFileCount(fileList.children.length);
        } else {
            showAlert('Error deleting file: ' + data.error, 'error');
        }
    })
    .catch(error => {
        showAlert('Error deleting file: ' + error.message, 'error');
    });
}

function deleteWebsite(websiteId) {
    if (!confirm('Are you sure you want to delete this website?')) return;
    
    // Get the selected assistant ID from URL
    const currentUrl = new URL(window.location);
    const selectedAssistantId = currentUrl.searchParams.get('selected') || '{{ selected_assistant.id }}';
    
    if (!selectedAssistantId || selectedAssistantId === 'None') {
        showAlert('No assistant selected', 'error');
        return;
    }
    
    fetch(`/assistants/${selectedAssistantId}/delete-website/${websiteId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Remove website item from DOM
            const websiteItem = document.querySelector(`[onclick="deleteWebsite(${websiteId})"]`).closest('.flex');
            websiteItem.remove();
            const websiteList = document.getElementById('website-list');
            updateWebsiteCount(websiteList.children.length);
        } else {
            showAlert('Error deleting website: ' + data.error, 'error');
        }
    })
    .catch(error => {
        showAlert('Error deleting website: ' + error.message, 'error');
    });
}

function loadKnowledgeBaseData(assistantId) {
    if (!assistantId || assistantId === 'None') return;
    
    // Validate UUID format before making request
    const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i;
    if (!uuidRegex.test(assistantId)) {
        console.warn('Invalid assistant ID format:', assistantId);
        return;
    }
    
    fetch(`/assistants/${assistantId}/knowledge-base/`)
    .then(response => response.json())
    .then(data => {
        if (data.success !== false) {
            // Populate file list
            const fileList = document.getElementById('file-list');
            fileList.innerHTML = '';
            data.files.forEach(file => {
                const fileItem = createFileItem(file);
                fileList.appendChild(fileItem);
            });
            
            // Populate website list
            const websiteList = document.getElementById('website-list');
            websiteList.innerHTML = '';
            data.websites.forEach(website => {
                const websiteItem = createWebsiteItem(website);
                websiteList.appendChild(websiteItem);
            });
            
            // Update counts
            updateFileCount(data.file_count);
            updateWebsiteCount(data.website_count);
            
            // Update height after loading data
            setTimeout(() => updateKnowledgeBaseHeight(), 100);
        }
    })
    .catch(error => {
        console.error('Error loading knowledge base data:', error);
    });
}

function updateFileCount(count) {
    const fileCountElement = document.getElementById('file-count');
    if (fileCountElement) {
        fileCountElement.textContent = count || 0;
    }
    // Recalculate knowledge base height after file count changes
    updateKnowledgeBaseHeight();
}

function updateWebsiteCount(count) {
    const websiteCountElement = document.getElementById('website-count');
    if (websiteCountElement) {
        websiteCountElement.textContent = count || 0;
    }
    // Recalculate knowledge base height after website count changes
    updateKnowledgeBaseHeight();
}

function updateKnowledgeBaseHeight() {
    // Update the height of the knowledge base section if it's expanded
    const knowledgeBaseContent = document.getElementById('collapsible-knowledge-base-tab-content');
    if (knowledgeBaseContent && knowledgeBaseContent.dataset.collapsed === 'false') {
        // Force recalculation by temporarily removing maxHeight
        knowledgeBaseContent.style.maxHeight = 'none';
        // Get the new scroll height
        const newHeight = knowledgeBaseContent.scrollHeight;
        // Set the new max height with smooth transition
        knowledgeBaseContent.style.maxHeight = newHeight + 'px';
    }
}

function getStatusBadgeClass(status) {
    switch (status) {
        case 'completed':
        case 'active':
            return 'badge-success';
        case 'pending':
        case 'adding':
            return 'badge-warning';
        case 'failed':
            return 'badge-error';
        case 'uploading':
            return 'badge-info';
        default:
            return 'badge-error';
    }
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

function showAlert(message, type = 'info') {
    const alert = document.createElement('div');
    alert.className = `alert alert-${type} fixed top-4 right-4 z-50 max-w-sm`;
    alert.innerHTML = `
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>
        <span>${message}</span>
    `;
    document.body.appendChild(alert);
    
    setTimeout(() => {
        alert.remove();
    }, 5000);
}

// Initialize when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, initializing...');
    

    
    // Quick create button under search
    const quickCreateBtn = document.getElementById('quick-create-assistant');
    if (quickCreateBtn) {
        console.log('Found quick create button');
        quickCreateBtn.addEventListener('click', (e) => {
            e.preventDefault();
            createAssistant(quickCreateBtn);
        });
    }
    
    // Empty state create button
    const emptyStateBtn = document.getElementById('empty-state-create-btn');
    if (emptyStateBtn) {
        console.log('Found empty state button');
        emptyStateBtn.addEventListener('click', (e) => {
            e.preventDefault();
            createAssistant(emptyStateBtn);
        });
    }
    
    // Save configuration button
    const saveConfigBtn = document.getElementById('save-config-btn');
    if (saveConfigBtn) {
        console.log('Found save config button');
        saveConfigBtn.addEventListener('click', (e) => {
            e.preventDefault();
            saveAssistantConfig(saveConfigBtn);
        });
    }
    
    // Assistant selection functionality
    const assistantItems = document.querySelectorAll('.assistant-item');
    console.log('Found assistant items:', assistantItems.length);
    assistantItems.forEach(item => {
        item.addEventListener('click', function(e) {
            e.preventDefault();
            const assistantId = this.dataset.assistantId;
            console.log('Clicked assistant:', assistantId);
            selectAssistant(assistantId);
        });
    });
    
    // Initialize voice provider change handler
    handleVoiceProviderChange();
    
    // Initialize audio configuration toggles
    handleAudioConfigurationToggles();
    
    // Initialize config toggle auto-save functionality
    handleConfigToggleAutoSave();
    
    // Update accordion height on page load if any audio settings are enabled
    setTimeout(() => {
        updateAccordionHeight('collapsible-voice-additional-tab-content');
    }, 100);
    
    // Also update after a longer delay to ensure all dynamic content is rendered
    setTimeout(() => {
        updateAccordionHeight('collapsible-voice-additional-tab-content');
    }, 500);
    
    // Initialize voice selection based on current configuration
    const voiceProviderSelect = document.getElementById('voice-provider');
    const voiceSelectionSelect = document.getElementById('voice-selection');
    
    if (voiceProviderSelect && voiceSelectionSelect) {
        const currentProvider = voiceProviderSelect.value;
        const currentVoiceId = voiceSelectionSelect.dataset.currentVoice;
        
        console.log('Initializing voice selection with provider:', currentProvider, 'voice:', currentVoiceId);
        
        // Update voice selection to show only voices for current provider
        updateVoiceSelection(currentProvider, currentVoiceId);
    }
    
    // Initialize knowledge base functionality
    initializeKnowledgeBase();
    
    // Add window resize listener to update accordion heights
    window.addEventListener('resize', () => {
        updateAllExpandedAccordions();
    });
    
    // Reload knowledge base data when assistant changes
    const currentUrl = new URL(window.location);
    let selectedAssistantId = currentUrl.searchParams.get('selected');
    
    // Fallback to template variable if no URL parameter
    if (!selectedAssistantId) {
        const templateAssistantId = '{{ selected_assistant.id|default:"" }}';
        selectedAssistantId = templateAssistantId !== '' && templateAssistantId !== 'None' ? templateAssistantId : null;
    }
    
    if (selectedAssistantId && selectedAssistantId !== 'None') {
        loadKnowledgeBaseData(selectedAssistantId);
    }
    
    // Initialize header positioning based on sidebar states
    initializeAssistantHeaderPositioning();
});

/**
 * Initialize the fixed header positioning with static sidebar width
 */
function initializeAssistantHeaderPositioning() {
    const fixedHeader = document.getElementById('assistants-fixed-header');
    const secondarySidebar = document.querySelector('.secondary-sidebar, aside[class*="w-80"]');
    
    if (!fixedHeader) {
        console.warn('Assistant fixed header not found');
        return;
    }
    
    console.log('Initializing assistant header positioning with static sidebar...');
    
    // Static positioning - main sidebar is always 320px, secondary is 320px
    const mainSidebarWidth = 320; // Static width
    const secondarySidebarWidth = secondarySidebar && secondarySidebar.offsetWidth > 0 ? 320 : 0;
    const totalLeftMargin = mainSidebarWidth + secondarySidebarWidth;
    
    console.log('Setting static header position:', {
        mainSidebarWidth,
        secondarySidebarWidth,
        totalLeftMargin
    });
    
    fixedHeader.style.left = `${totalLeftMargin}px`;
}
</script>

<!-- Add CSRF token for AJAX requests -->
{% csrf_token %}
{% endblock %}
